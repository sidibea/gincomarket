<?php
///-build_id: 2016071823.0745
/// This source file is subject to the Software License Agreement that is bundled with this 
/// package in the file license.txt, or you can get it here
/// http://addons-modules.com/en/content/3-terms-and-conditions-of-use
///
/// @copyright  2009-2012 Addons-Modules.com
///  If you need open code to customize or merge code with othe modules, please contact us.
include_once(_PS_ROOT_DIR_ .'/modules/agilesellershipping/agilesellershipping.php');

class AgileSellerShippingSellerCarrierDetailModuleFrontController extends AgileModuleFrontController
{
	public function __construct()   {    parent::__construct();             $this->table = 'carrier';          $this->identifier = 'id_carrier';          $this->className = 'Carrier';      }       public function init()   {    parent::init();        header('Cache-Control: no-cache, must-revalidate');    header('Expires: Sat, 26 Jul 1997 05:00:00 GMT');      $this->max_image_size = (int)Configuration::get('PS_PRODUCT_PICTURE_MAX_SIZE') / 1000;    $this->languages = Language::getLanguages(false);      $this->id_object = Carrier::getActiveIDByID((int)Tools::getValue('id_carrier'));    if($this->id_object != (int)Tools::getValue('id_carrier'))    {     Tools::redirect($this->context->link->getModuleLink('agilesellershipping','sellercarrierdetail',array('id_carrier'=>$this->id_object), true));    }        $this->object = new Carrier($this->id_object);      $R1B8AE585FCBE16464BB4673988D498E2 = AgileSellerManager::getObjectOwnerID('carrier', Tools::getValue('id_carrier'));        $R17580FDEFC33F6F2D6227DC3791548D7 = ($this->id_object == 0 OR ($R1B8AE585FCBE16464BB4673988D498E2 > 0 && $R1B8AE585FCBE16464BB4673988D498E2 == $this->sellerinfo->id_seller));    $RF096F676CD7E3159B177824FB957F8E5 = ($R1B8AE585FCBE16464BB4673988D498E2 == 0);    if(!$R17580FDEFC33F6F2D6227DC3791548D7 AND !$RF096F676CD7E3159B177824FB957F8E5)    {     $this->errors[] = Tools::displayError('You do not have permission to access carrier. ');    }        $this->context->smarty->assign(array(     'hasOwnerShip' => $R17580FDEFC33F6F2D6227DC3791548D7     ,'isSharedCarrier' => $RF096F676CD7E3159B177824FB957F8E5     ,'isCarrierInitial' => (empty($_POST)? 1 : 0)    ));   }     public function setMedia()   {    parent::setMedia();    $this->addCSS(_PS_ROOT_DIR_.'/modules/agilesellershipping/css/agilesellersshipping.css', 'all');      $this->addJS(array(    _PS_ROOT_DIR_.'/modules/agilemultipleseller/js/agile_tiny_mce.js',    _PS_ROOT_DIR_.'/modules/agilemultipleseller/replica/filemanager/plugin.js',    _PS_JS_DIR_.'admin.js',    _PS_JS_DIR_.'jquery/plugins/jquery.typewatch.js',    _PS_JS_DIR_.'jquery/ui/jquery.ui.core.min.js',    _PS_JS_DIR_.'jquery/ui/jquery.ui.widget.min.js',    _PS_JS_DIR_.'jquery/ui/jquery.ui.mouse.min.js',    _PS_JS_DIR_.'jquery/ui/jquery.ui.slider.min.js',    _PS_JS_DIR_.'jquery/ui/jquery.ui.widget.min.js',    _PS_JS_DIR_.'jquery/ui/jquery.ui.datepicker.min.js',    _PS_JS_DIR_.'jquery/plugins/timepicker/jquery-ui-timepicker-addon.js',    _PS_ROOT_DIR_.'/modules/agilemultipleseller/replica/themes/default/js/dropdown.js',     ));    if(version_compare(_PS_VERSION_,'1.6.0.12','>='))    {     $this->addJS(array(      _PS_JS_DIR_.'admin/tinymce.inc.js',      ));    }    else    {     $this->addJS(array(      _PS_JS_DIR_.'tinymce.inc.js',     ));    }      $this->addCSS(array(     _PS_JS_DIR_ . 'jquery/ui/themes/base/jquery.ui.theme.css',     _PS_JS_DIR_ . 'jquery/ui/themes/base/jquery.ui.datepicker.css',     ));   }      public function getMessage($RF413F06AEBBCEF5E1C8B1019DEE6FE6B)   {    $RA43A52C3D1634FFA3BF745E85786DC5E = array(     'Price rule successfully updated' => $this->l('Price rule successfully updated')     ,'If you wish to use the advanced stock management, you have to:' => $this->l('If you wish to use the advanced stock management, you have to:')     ,'associate your carriers with warehouses' => $this->l('associate your carriers with warehouses')     ,'associate your warehouses with carriers' => $this->l('associate your warehouses with carriers')     ,'associate your warehouses with the appropriate shops' => $this->l('associate your warehouses with the appropriate shops')     ,'You must have a common warehouse between this pack and its carrier.' => $this->l('You must have a common warehouse between this pack and its carrier.')     ,'You must save this carrier before managing quantities.' => $this->l('You must save this carrier before managing quantities.')     ,'You must save this carrier before adding specific prices' => $this->l('You must save this carrier before adding specific prices')     ,'This feature has been disabled, you can activate this feature at this page:' => $this->l('This feature has been disabled, you can activate this feature at this page:')     ,'link to Performances' => $this->l('link to Performances')     ,'A virtual carrier cannot have combinations.' => $this->l('A virtual carrier cannot have combinations.')     ,'You must save this carrier before adding combinations.' => $this->l('You must save this carrier before adding combinations.')    );    return $RA43A52C3D1634FFA3BF745E85786DC5E[$RF413F06AEBBCEF5E1C8B1019DEE6FE6B];   }      public function displayAjax()   {    $this->display();   }       public function initContent()   {    parent::initContent();      $this->initContentCommon();    $this->setTemplate('sellercarrierdetail.tpl');   }      private function initContentCommon()   {    $R4EA26E7DEBFD8BAD8718473F5E3D2525 = array_merge(array(array('id_tax_rules_group' => 0, 'name' => $this->l('No Tax'))), TaxRulesGroup::getTaxRulesGroups(true));      $RE4383934787B83B49DDB150913CF42D2 = Language::getLanguages(false);    $RE5D918B5A95D7667BA4C88872B4ABD3A = Zone::getZones(false);    $R46EA1487D4C36CFD9F79F867F0E05EAB = $this->object->getZones();    $R7C1C305C10519AC5BAFAECCED2F38A1E = array();    if (is_array($R46EA1487D4C36CFD9F79F867F0E05EAB))     foreach ($R46EA1487D4C36CFD9F79F867F0E05EAB as $RC5EBDB8AB4077514D19D3D53DC0A2325)      $R7C1C305C10519AC5BAFAECCED2F38A1E[] = $RC5EBDB8AB4077514D19D3D53DC0A2325['id_zone'];          $RB67F4F4FC0A88900A925BA14A75BBE2B = Group::getGroups($this->context->language->id);    $RF4B2CA03F612384E2A7BB170E562337A = $this->object->getGroups();    $R20A740934E84EC0E81A7DB0DE87C90F2 = array();    if (is_array($RF4B2CA03F612384E2A7BB170E562337A))     foreach ($RF4B2CA03F612384E2A7BB170E562337A as $RD6233B7C352917C42537F600B30203B0)      $R20A740934E84EC0E81A7DB0DE87C90F2[] = $RD6233B7C352917C42537F600B30203B0['id_group'];        $R9E4A779FF621C04A67567AA3C56F25A1 = array(      array(       'id' => 'billing_price',       'value' => Carrier::SHIPPING_METHOD_PRICE,       'label' => $this->l('According to total price')       ),      array(       'id' => 'billing_weight',       'value' => Carrier::SHIPPING_METHOD_WEIGHT,       'label' => $this->l('According to total weight')       )      );      $REFC9FCEF33C0130D1C999E494309EC80 = array(      array(       'id' => 0,       'name' => $this->l('Apply the cost of the highest defined range')       ),      array(       'id' => 1,       'name' => $this->l('Disable carrier')       )      );      $R4C5B9668E9193446CF1DFDE3F44A771A = file_exists(_PS_SHIP_IMG_DIR_.$this->id_object.'.jpg');      $RD5DD13CE0AA26ABB33F9D5F83833D4E8 = false;    $R21FE92839E4D2C527A1ABED09C35DBB9 = false;    if(Module::isInstalled('agilecashondelivery') && Module::isEnabled('agilecashondelivery'))    {     $this->addJs(_PS_ROOT_DIR_.'/modules/agilecashondelivery/js/codAdmin.js');     $this->addCSS(_PS_ROOT_DIR_.'/modules/agilecashondelivery/css/carrier_popup.css');     $RD5DD13CE0AA26ABB33F9D5F83833D4E8 = true;     require_once(_PS_ROOT_DIR_.'/modules/agilecashondelivery/AgileCarrierCod.php');     $R47B37AF27672BEE2E8C872922FE41D1D = new AgileCarrierCod();     $R21FE92839E4D2C527A1ABED09C35DBB9 = $R47B37AF27672BEE2E8C872922FE41D1D->getHandleCodByCarrierId(Tools::getValue('id_carrier'));     if(isset($R21FE92839E4D2C527A1ABED09C35DBB9[0]))     {      $R21FE92839E4D2C527A1ABED09C35DBB9 = $R21FE92839E4D2C527A1ABED09C35DBB9[0]['handle_cod'];      }    }    $RA8471D7B63043122EA7A51E8E43B7D96 = $R21FE92839E4D2C527A1ABED09C35DBB9;    $REAC0E3B612BFD076E89A19F238D651A5 = Tools::getHttpHost(true).__PS_BASE_URI__;             $this->context->smarty->assign(array(     'seller_tab_id' => 6     ,'id_carrier' => $this->id_object     ,'carrier' => $this->object     ,'taxes' => $R4EA26E7DEBFD8BAD8718473F5E3D2525     ,'zones' => $RE5D918B5A95D7667BA4C88872B4ABD3A     ,'zone_ids' => $R7C1C305C10519AC5BAFAECCED2F38A1E     ,'groups' => $RB67F4F4FC0A88900A925BA14A75BBE2B     ,'carrier_groups_ids' => $R20A740934E84EC0E81A7DB0DE87C90F2     ,'billings' => $R9E4A779FF621C04A67567AA3C56F25A1     ,'range_behaviors' => $REFC9FCEF33C0130D1C999E494309EC80     ,'languages' => $RE4383934787B83B49DDB150913CF42D2     ,'default_language' => $this->context->cookie->id_lang     ,'step' => 0     ,'logo_set' => $R4C5B9668E9193446CF1DFDE3F44A771A     ,'base_url' => $REAC0E3B612BFD076E89A19F238D651A5     ,'support_cod' => $RA8471D7B63043122EA7A51E8E43B7D96     ,'enableCashOnDelivery' => $RD5DD13CE0AA26ABB33F9D5F83833D4E8   ));   }              public function postProcess()   {          $_POST['id_seller'] = AgileSellerManager::getLinkedSellerID($this->context->customer->id);    $this->object->indexed = 0;        if (Tools::getValue('submitAdd') or Tools::getValue('submitNext'))    {     $this->validateRules();     if (count($this->errors))     {      $this->copyFromPost($this->object, $this->table);      return;     }       $this->copyFromPost($this->object, $this->table);          $RE5D918B5A95D7667BA4C88872B4ABD3A = Zone::getZones(false);     $RAC33B813FDF589EF53806D9507AF0E58 = false;     foreach ($RE5D918B5A95D7667BA4C88872B4ABD3A as $R65D0BDE1CE365AF7E94B8D0C9775D247)     {      if(isset($_POST['zone_'.$R65D0BDE1CE365AF7E94B8D0C9775D247['id_zone']]))      {       $RAC33B813FDF589EF53806D9507AF0E58= true;       break;      }     }     if(!$RAC33B813FDF589EF53806D9507AF0E58)     {      $this->errors[] = Tools::displayError('At least one zone is required.');      return;     }          if($this->id_object > 0)     {       try {       $R08DFC2BBD19692B9A6EAAF37CC117C06 = new Carrier($this->id_object);       if (!Validate::isLoadedObject($R08DFC2BBD19692B9A6EAAF37CC117C06))        throw new PrestaShopException('Cannot load Carrier object');                    $R505D8370FF8B5CB704726E0FBF3EBA51 = $R08DFC2BBD19692B9A6EAAF37CC117C06->duplicateObject();       if (Validate::isLoadedObject($R505D8370FF8B5CB704726E0FBF3EBA51))       {              $R08DFC2BBD19692B9A6EAAF37CC117C06->deleted = true;        $R08DFC2BBD19692B9A6EAAF37CC117C06->update();                $this->copyFromPost($R505D8370FF8B5CB704726E0FBF3EBA51, $this->table);        $R505D8370FF8B5CB704726E0FBF3EBA51->position = $R08DFC2BBD19692B9A6EAAF37CC117C06->position;        $R505D8370FF8B5CB704726E0FBF3EBA51->update();          $this->updateAssoShop($R505D8370FF8B5CB704726E0FBF3EBA51->id);        $R505D8370FF8B5CB704726E0FBF3EBA51->copyCarrierData((int)$R08DFC2BBD19692B9A6EAAF37CC117C06->id);        $R505D8370FF8B5CB704726E0FBF3EBA51->setTaxRulesGroup((int)Tools::getValue('id_tax_rules_group'), true);        $this->changeGroups($R505D8370FF8B5CB704726E0FBF3EBA51->id);              Hook::exec('actionCarrierUpdate', array(         'id_carrier' => (int)$R08DFC2BBD19692B9A6EAAF37CC117C06->id,         'carrier' => $R505D8370FF8B5CB704726E0FBF3EBA51         ));        $this->changeZones($R505D8370FF8B5CB704726E0FBF3EBA51->id);              $this->processLogoUpload($R505D8370FF8B5CB704726E0FBF3EBA51->id);        if(Tools::getValue('submitNext'))        {         Tools::redirect('index.php?process=carrier&fc=module&module=agilesellershipping&controller=sellercarrierranges&id_carrier='.$R505D8370FF8B5CB704726E0FBF3EBA51->id);        }else        {         Tools::redirect('index.php?process=carriers&fc=module&module=agilesellershipping&controller=sellercarriers');        }       }       else       {        $this->errors[] = Tools::displayError('An error occurred while updating object.').' <b>'.$this->table.'</b>';       }      } catch (PrestaShopException $R0D54236DA20594EC13FC81B209733931) {       $this->errors[] = $R0D54236DA20594EC13FC81B209733931->getMessage();      }     }else     {      $R53CED8F460F10F938CCEC04FE634E4D3 = new Carrier();      $this->copyFromPost($R53CED8F460F10F938CCEC04FE634E4D3, $this->table);      $R53CED8F460F10F938CCEC04FE634E4D3->position = Carrier::getHigherPosition() + 1;      if ($R53CED8F460F10F938CCEC04FE634E4D3->add())      {       $R53CED8F460F10F938CCEC04FE634E4D3->setTaxRulesGroup((int)Tools::getValue('id_tax_rules_group'), true);       $this->changeZones($R53CED8F460F10F938CCEC04FE634E4D3->id);       $this->changeGroups($R53CED8F460F10F938CCEC04FE634E4D3->id);       $this->updateAssoShop($R53CED8F460F10F938CCEC04FE634E4D3->id);       $this->processLogoUpload($R53CED8F460F10F938CCEC04FE634E4D3->id);       if(Tools::getValue('submitNext'))       {        Tools::redirect('index.php?process=shipping&fc=module&module=agilesellershipping&controller=sellercarrierranges&id_carrier='.$R53CED8F460F10F938CCEC04FE634E4D3->id);       }else       {        Tools::redirect('index.php?process=shipping&fc=module&module=agilesellershipping&controller=sellercarriers');       }      }      else      {       $this->errors[] = Tools::displayError('An error occurred while creating object.');      }     }    }   }      protected function changeGroups($R0ACBF3334E5196BD6BFD3ADC13786C4C, $R3AA041D3204639AA7E79B914AB91B756 = true)   {    if ($R3AA041D3204639AA7E79B914AB91B756)     Db::getInstance()->execute('DELETE FROM '._DB_PREFIX_.'carrier_group WHERE id_carrier = '.(int)$R0ACBF3334E5196BD6BFD3ADC13786C4C);    $RB67F4F4FC0A88900A925BA14A75BBE2B = Db::getInstance()->executeS('SELECT id_group FROM `'._DB_PREFIX_.'group`');    foreach ($RB67F4F4FC0A88900A925BA14A75BBE2B as $R87AEE2288494E53FB8611A590D3512AC)     if (Tools::getIsset('groupBox') && in_array($R87AEE2288494E53FB8611A590D3512AC['id_group'], Tools::getValue('groupBox')))      Db::getInstance()->execute('       INSERT INTO '._DB_PREFIX_.'carrier_group (id_group, id_carrier)       VALUES('.(int)$R87AEE2288494E53FB8611A590D3512AC['id_group'].','.(int)$R0ACBF3334E5196BD6BFD3ADC13786C4C.')      ');   }     public function changeZones($R3584859062EA9ECFB39B93BFCEF8E869)   {    $R53CED8F460F10F938CCEC04FE634E4D3 = new $this->className($R3584859062EA9ECFB39B93BFCEF8E869);    if (!Validate::isLoadedObject($R53CED8F460F10F938CCEC04FE634E4D3))     die (Tools::displayError('Object cannot be loaded'));    $RE5D918B5A95D7667BA4C88872B4ABD3A = Zone::getZones(false);    foreach ($RE5D918B5A95D7667BA4C88872B4ABD3A as $R65D0BDE1CE365AF7E94B8D0C9775D247)     if (count($R53CED8F460F10F938CCEC04FE634E4D3->getZone($R65D0BDE1CE365AF7E94B8D0C9775D247['id_zone'])))     {      if (!isset($_POST['zone_'.$R65D0BDE1CE365AF7E94B8D0C9775D247['id_zone']]) || !$_POST['zone_'.$R65D0BDE1CE365AF7E94B8D0C9775D247['id_zone']])       $R53CED8F460F10F938CCEC04FE634E4D3->deleteZone($R65D0BDE1CE365AF7E94B8D0C9775D247['id_zone']);     }     else      if (isset($_POST['zone_'.$R65D0BDE1CE365AF7E94B8D0C9775D247['id_zone']]) && $_POST['zone_'.$R65D0BDE1CE365AF7E94B8D0C9775D247['id_zone']])       $R53CED8F460F10F938CCEC04FE634E4D3->addZone($R65D0BDE1CE365AF7E94B8D0C9775D247['id_zone']);   }     public function processLogoUpload($RC8835E30C6A01D78924D17FA5FC44DBA)   {    if($RC8835E30C6A01D78924D17FA5FC44DBA<=0) return;    $R3B0223C5910DFCF360C756E15DE4DA22 = _PS_SHIP_IMG_DIR_;    if(!empty($_FILES['logo']['name']))    {     $R3656889A448A7AF799D2D7955BED2354 = _PS_SHIP_IMG_DIR_. $RC8835E30C6A01D78924D17FA5FC44DBA. ".jpg";     if(!move_uploaded_file($_FILES['logo']['tmp_name'], $R3656889A448A7AF799D2D7955BED2354)) {     }      }   }  }    