<?php
///-build_id: 2016071823.0745
/// This source file is subject to the Software License Agreement that is bundled with this 
/// package in the file license.txt, or you can get it here
/// http://addons-modules.com/en/content/3-terms-and-conditions-of-use
///
/// @copyright  2009-2012 Addons-Modules.com
///  If you need open code to customize or merge code with othe modules, please contact us.
require_once(_PS_ROOT_DIR_ . '/modules/agilesellershipping/SellerShipping.php');

class AgileSellerShipping extends Module
{
	const INSTALL_SQL_FILE = 'install.sql';
	const USE_DEFAULT_CARRIER_NO = 0;
	const USE_DEFAULT_CARRIER_WHEN_NO_CARRIERS = 1;
	const USE_DEFAULT_CARRIER_ALWAYS = 2;

	private $version_dependencies = array();

	protected	$_html = '';
	protected $_postErrors = array();


	function __construct()   {    $this->name = 'agilesellershipping';    $this->isAgileKernelCompatible = true;    $this->tab = 'administration';    $this->bootstrap = true;    $this->author = 'addons-modules.com';    $this->version = '2.5.0.3';    $this->ps_versions_compliancy = array('min' => '1.6', 'max' => _PS_VERSION_);    $this->dependencies = array('agilemultipleseller','agilekernel');    $this->version_dependencies = array('agilemultipleseller' => '3.3.0.1', 'agilekernel'=>'1.0.0.1');     $this->newfiles = array();      parent::__construct();        $this->displayName = $this->l('Agile Seller Shipping module');    $this->description = $this->l('Provides shipping configuration functions to sellers');   }     function install()   {    if(!Module::isInstalled('agilekernel'))    {     $this->_errors[] = $this->l('You have to install Agile Kernel module before installing this module. The download link of this module should have been included your download email for your order. If you can not find it, please request by email to support@addons-modules.com with your order #.');     return false;    }        if(Module::isInstalled('carriercompare'))    {     $this->_errors[] = $this->l('Please uninstall PrestaShop original Carrier Compare module before install this module, because it is not compatible with ths module.');     return false;       }        $R24DD45B1C43192100CB0BCF98D0AEF9C = AgileInstaller::version_depencies($this->version_dependencies);    if(!empty($R24DD45B1C43192100CB0BCF98D0AEF9C)){     $this->_errors = array_merge($this->_errors, $R24DD45B1C43192100CB0BCF98D0AEF9C);     return false;    }      if(!AgileInstaller::sql_install(dirname(__FILE__).'/'.self::INSTALL_SQL_FILE))     return false;      if(Module::isInstalled('agilepickupcenter')) AgileInstaller::add_field_ifnotexists('agile_cartcarrier','id_location','bigint(11)','0');        $R6CD996866E2BBF02D20BE7CCDCB9D7B9 =  Carrier::getActiveIDByID(Configuration::get('AGILE_SS_CARRIER_ID'));    if($R6CD996866E2BBF02D20BE7CCDCB9D7B9 == 0)$R6CD996866E2BBF02D20BE7CCDCB9D7B9 = $this->createLinkedCarrier();      if  (parent::install() == false      OR Configuration::updateValue('AGILE_SS_CARRIER_ID', $R6CD996866E2BBF02D20BE7CCDCB9D7B9) == false     OR Configuration::updateValue('AGILE_SS_AS_DEFAULT_CARRIER', AgileSellerShipping::USE_DEFAULT_CARRIER_WHEN_NO_CARRIERS) == false    )     return false;      if (!$this->registerHook('displayBeforeCarrier')     OR !$this->registerHook('displayCarrierList')     OR !$this->registerHook('actionCarrierUpdate')     OR !$this->registerHook('actionCartSave')    ) return false;      if(version_compare(_PS_VERSION_, '1.5', '>='))Autoload::getInstance()->generateIndex();        return true;   }         public function uninstall()   {      include_once(_PS_ROOT_DIR_ . '/modules/agilekernel/agilekernel.php');    $R6179FA849D1810F18B98D67F1A539A07 = new AgileKernel();    $RA82B8E922943C74082F982E24398CA04 = $R6179FA849D1810F18B98D67F1A539A07->uninstall_shared_override($this->name);    if(!empty($RA82B8E922943C74082F982E24398CA04))return false;              if(!parent::uninstall())return false;        $R6CD996866E2BBF02D20BE7CCDCB9D7B9 = Configuration::get('AGILE_SS_CARRIER_ID');    Db::getInstance()->Execute('UPDATE '._DB_PREFIX_.'carrier SET deleted=1 WHERE id_carrier='.intval($R6CD996866E2BBF02D20BE7CCDCB9D7B9));      return true;   }       public function hookDisplayBeforeCarrier($RC2D2567438B1F39DD71F78195B5F3DED)   {    include_once(_PS_ROOT_DIR_  . "/modules/agilesellershipping/SellerShipping.php");        $R3CA092FF89E1C9FFB12399030355F8FC = SellerShipping::getZoneID($this->context->cart->id_address_delivery, $this->context->cart->id_customer);        $RE552C03393DCDC6A5F98C3B5596C9525 = SellerShipping::products_without_carrier($R3CA092FF89E1C9FFB12399030355F8FC, $this->context->cart->id , $this->context->language->id);    $this->context->smarty->assign(array(     'products_without_carrier' => $RE552C03393DCDC6A5F98C3B5596C9525     ,'products_without_carrier_nbr' => count($RE552C03393DCDC6A5F98C3B5596C9525)     ));      return $this->display(__FILE__, '/views/templates/hook/hookbeforecarrier.tpl');       }     public function hookCarrierTotalSummary($RC2D2567438B1F39DD71F78195B5F3DED)   {    if(!$this->active)return;    $RF50CDD3F2AACFD3098534F1C052C25BE = $RC2D2567438B1F39DD71F78195B5F3DED['id_cart'];    if(!$RF50CDD3F2AACFD3098534F1C052C25BE)return;        include_once(_PS_ROOT_DIR_  . "/modules/agilesellershipping/SellerShipping.php");    include_once(_PS_ROOT_DIR_  . "/modules/agilemultipleseller/agilemultipleseller.php");    $R996C30A3573BB68AFD6EA613086EF8AA = true;      $R4C40966EA8337EFDF326315499413376 = AgileMultipleSeller::getSellersByCart($RF50CDD3F2AACFD3098534F1C052C25BE);    if(empty($R4C40966EA8337EFDF326315499413376))return;        $R5471C5AA40E5F9894EB231BCA4CA9DBE = array();    $RF9AA09C4492B9A9D072FC9F115B8C9AE = new Cart($RF50CDD3F2AACFD3098534F1C052C25BE);    $R3CA092FF89E1C9FFB12399030355F8FC = SellerShipping::getZoneID($RF9AA09C4492B9A9D072FC9F115B8C9AE->id_address_delivery, $RF9AA09C4492B9A9D072FC9F115B8C9AE->id_customer);    $R743CE00DE0F4FEA746D03BBAE2968D01 = $RF9AA09C4492B9A9D072FC9F115B8C9AE->getProducts();    $R2CB451383C210098125CCAE99CC07D78 = array();    foreach($R743CE00DE0F4FEA746D03BBAE2968D01 as $p)    {     $R2CB451383C210098125CCAE99CC07D78[$p['id_product']] = $p;    }    foreach($R4C40966EA8337EFDF326315499413376 AS $R17AC9BFA1ABB066C772CEAE0B3CD86E9)    {     $R95909C49377A2B4F24C79D29C629AF65 = intval($R17AC9BFA1ABB066C772CEAE0B3CD86E9['id_seller']);        $R6609F7AAD44B2D5DA0ED8F6A149537CB = array();        $RB2527A08352425D7934563CF8CBFE0B7 = SellerShipping::get_carrier_products($RF50CDD3F2AACFD3098534F1C052C25BE, $R95909C49377A2B4F24C79D29C629AF65);     if(!empty($RB2527A08352425D7934563CF8CBFE0B7))     {          $RF084133C98835D952E6375C23E4756E6 = $RF9AA09C4492B9A9D072FC9F115B8C9AE->get_carrier_product_amount($RB2527A08352425D7934563CF8CBFE0B7, $R743CE00DE0F4FEA746D03BBAE2968D01, $R2CB451383C210098125CCAE99CC07D78);      foreach($RF084133C98835D952E6375C23E4756E6 AS $R0ACBF3334E5196BD6BFD3ADC13786C4C=>$RE119E1E2C9C6B602CE34720BC6B80682)      {            $R53CED8F460F10F938CCEC04FE634E4D3 = new Carrier($R0ACBF3334E5196BD6BFD3ADC13786C4C);       $RB2C3CDAEC3D6B89774B582C453175A20 = $RF9AA09C4492B9A9D072FC9F115B8C9AE->getTotalWeightOfCarrier($R0ACBF3334E5196BD6BFD3ADC13786C4C,$R95909C49377A2B4F24C79D29C629AF65);        if($RF9AA09C4492B9A9D072FC9F115B8C9AE->is_all_virtual($R0ACBF3334E5196BD6BFD3ADC13786C4C, $RB2527A08352425D7934563CF8CBFE0B7,$R2CB451383C210098125CCAE99CC07D78))        $R89FFEECBCD7B7E3554EE955B40610E80 =  0;       else        $R89FFEECBCD7B7E3554EE955B40610E80 = $RF9AA09C4492B9A9D072FC9F115B8C9AE->getOrderShippingCostPerSellerCarrier($R95909C49377A2B4F24C79D29C629AF65, $R996C30A3573BB68AFD6EA613086EF8AA, $R3CA092FF89E1C9FFB12399030355F8FC, $R0ACBF3334E5196BD6BFD3ADC13786C4C, $RE119E1E2C9C6B602CE34720BC6B80682,$RB2C3CDAEC3D6B89774B582C453175A20);       if(Module::isInstalled('agilepickupcenter')         && $R0ACBF3334E5196BD6BFD3ADC13786C4C == intval(Configuration::getGlobalValue('AGILE_PICKUPCENTER_CARRIER_ID')) )       {        $R6609F7AAD44B2D5DA0ED8F6A149537CB[] = array('carrier'=>$R53CED8F460F10F938CCEC04FE634E4D3->name,'total'=>Tools::displayPrice($R89FFEECBCD7B7E3554EE955B40610E80),'products'=>$this->getProductnameListForCarrierLocation($R743CE00DE0F4FEA746D03BBAE2968D01,$RB2527A08352425D7934563CF8CBFE0B7,$R0ACBF3334E5196BD6BFD3ADC13786C4C));       }       else {         $R6609F7AAD44B2D5DA0ED8F6A149537CB[] = array('carrier'=>$R53CED8F460F10F938CCEC04FE634E4D3->name,'total'=>Tools::displayPrice($R89FFEECBCD7B7E3554EE955B40610E80),'products'=>$this->getProductnameListForCarrier($R743CE00DE0F4FEA746D03BBAE2968D01,$RB2527A08352425D7934563CF8CBFE0B7,$R0ACBF3334E5196BD6BFD3ADC13786C4C));       }      }     }     if($R95909C49377A2B4F24C79D29C629AF65 == 0)$R17AC9BFA1ABB066C772CEAE0B3CD86E9['company'] = Configuration::get('PS_SHOP_NAME');     $R5471C5AA40E5F9894EB231BCA4CA9DBE[] = array('id_seller'=>$R95909C49377A2B4F24C79D29C629AF65,'seller_name'=>$R17AC9BFA1ABB066C772CEAE0B3CD86E9['company'],'details'=>$R6609F7AAD44B2D5DA0ED8F6A149537CB);    }        $this->context->smarty->assign(array(     'carriertotalsummary' => $R5471C5AA40E5F9894EB231BCA4CA9DBE     ));    return $this->display(__FILE__, '/views/templates/hook/hookcarriertotalsummary.tpl');   }         private function getProductnameListForCarrier($R743CE00DE0F4FEA746D03BBAE2968D01,$RB2527A08352425D7934563CF8CBFE0B7, $R0ACBF3334E5196BD6BFD3ADC13786C4C)   {    $R034AE2AB94F99CC81B389A1822DA3353 = '';    foreach($RB2527A08352425D7934563CF8CBFE0B7 AS $RCD65ED2249065FEDC55DD491E8EB672E)    {     if($RCD65ED2249065FEDC55DD491E8EB672E['id_carrier']!=$R0ACBF3334E5196BD6BFD3ADC13786C4C)continue;     foreach($R743CE00DE0F4FEA746D03BBAE2968D01 As $RB3F07F8C3658A835940E88288B58F707)     {      if($RB3F07F8C3658A835940E88288B58F707['id_product']==$RCD65ED2249065FEDC55DD491E8EB672E['id_product'] AND $RB3F07F8C3658A835940E88288B58F707['id_product_attribute']==$RCD65ED2249065FEDC55DD491E8EB672E['id_product_attribute'] )      {       $R034AE2AB94F99CC81B389A1822DA3353 .= $RB3F07F8C3658A835940E88288B58F707['name'];       if(isset($RB3F07F8C3658A835940E88288B58F707['attributes']))$R034AE2AB94F99CC81B389A1822DA3353 .= '(' . $RB3F07F8C3658A835940E88288B58F707['attributes'] . ')';       $R034AE2AB94F99CC81B389A1822DA3353 .= '<br />';      }     }    }    return $R034AE2AB94F99CC81B389A1822DA3353;   }     private function getProductnameListForCarrierLocation($R743CE00DE0F4FEA746D03BBAE2968D01,$RB2527A08352425D7934563CF8CBFE0B7, $R0ACBF3334E5196BD6BFD3ADC13786C4C)   {    $R034AE2AB94F99CC81B389A1822DA3353 = '';    $RBD77092B249DD66EF0B009A46427535F = array();    foreach($RB2527A08352425D7934563CF8CBFE0B7 AS $RCD65ED2249065FEDC55DD491E8EB672E)    {     if($RCD65ED2249065FEDC55DD491E8EB672E['id_carrier']== $R0ACBF3334E5196BD6BFD3ADC13786C4C)      {      $RBD77092B249DD66EF0B009A46427535F[]=$RCD65ED2249065FEDC55DD491E8EB672E['id_location'];     }    }    if(count($RBD77092B249DD66EF0B009A46427535F) > 0)     {     $RBD77092B249DD66EF0B009A46427535F = array_unique($RBD77092B249DD66EF0B009A46427535F);    }    foreach($RBD77092B249DD66EF0B009A46427535F As $RAE94F1F0304E14D2AFEE5B99285CBB58)     {     $R034AE2AB94F99CC81B389A1822DA3353 .= $this->getProductnameListForCarrierPickupLocation($R743CE00DE0F4FEA746D03BBAE2968D01,$RB2527A08352425D7934563CF8CBFE0B7, $R0ACBF3334E5196BD6BFD3ADC13786C4C,intval($RAE94F1F0304E14D2AFEE5B99285CBB58));    }    return $R034AE2AB94F99CC81B389A1822DA3353;   }     private function getProductnameListForCarrierPickupLocation($R743CE00DE0F4FEA746D03BBAE2968D01,$RB2527A08352425D7934563CF8CBFE0B7, $R0ACBF3334E5196BD6BFD3ADC13786C4C,$RB4C21F041201E5B437AE2F7A0141A18A)   {    $R034AE2AB94F99CC81B389A1822DA3353 = '';    if(intval($RB4C21F041201E5B437AE2F7A0141A18A) == 0) {     foreach($RB2527A08352425D7934563CF8CBFE0B7 AS $RCD65ED2249065FEDC55DD491E8EB672E)     {      if($RCD65ED2249065FEDC55DD491E8EB672E['id_carrier'] != $R0ACBF3334E5196BD6BFD3ADC13786C4C)continue;      foreach($R743CE00DE0F4FEA746D03BBAE2968D01 As $RB3F07F8C3658A835940E88288B58F707)      {       if($RB3F07F8C3658A835940E88288B58F707['id_product']==$RCD65ED2249065FEDC55DD491E8EB672E['id_product'] AND $RB3F07F8C3658A835940E88288B58F707['id_product_attribute']==$RCD65ED2249065FEDC55DD491E8EB672E['id_product_attribute'])       {        if($R034AE2AB94F99CC81B389A1822DA3353 == '')          $R034AE2AB94F99CC81B389A1822DA3353 = '<h5>' . $this->l('Pick up location : ') .  $this->l('There is no pickup locatiion available') .' </h5>';        $R034AE2AB94F99CC81B389A1822DA3353 .= $RB3F07F8C3658A835940E88288B58F707['name'];        if(isset($RB3F07F8C3658A835940E88288B58F707['attributes']))$R034AE2AB94F99CC81B389A1822DA3353 .= '(' . $RB3F07F8C3658A835940E88288B58F707['attributes'] . ')';        $R034AE2AB94F99CC81B389A1822DA3353 .= '<br />';       }      }     }    }    else    {     foreach($RB2527A08352425D7934563CF8CBFE0B7 AS $RCD65ED2249065FEDC55DD491E8EB672E)     {      if($RCD65ED2249065FEDC55DD491E8EB672E['id_carrier']!=$R0ACBF3334E5196BD6BFD3ADC13786C4C OR $RCD65ED2249065FEDC55DD491E8EB672E['id_location'] != $RB4C21F041201E5B437AE2F7A0141A18A)continue;      foreach($R743CE00DE0F4FEA746D03BBAE2968D01 As $RB3F07F8C3658A835940E88288B58F707)      {       if($RB3F07F8C3658A835940E88288B58F707['id_product']==$RCD65ED2249065FEDC55DD491E8EB672E['id_product'] AND $RB3F07F8C3658A835940E88288B58F707['id_product_attribute']==$RCD65ED2249065FEDC55DD491E8EB672E['id_product_attribute'])       {        if($R034AE2AB94F99CC81B389A1822DA3353 == '')          $R034AE2AB94F99CC81B389A1822DA3353 = '<h5>' . $this->l('Pick up location : ') . $RCD65ED2249065FEDC55DD491E8EB672E['location'] . ' (' . $RCD65ED2249065FEDC55DD491E8EB672E['address1'] . ') </h5>';        $R034AE2AB94F99CC81B389A1822DA3353 .= $RB3F07F8C3658A835940E88288B58F707['name'];        if(isset($RB3F07F8C3658A835940E88288B58F707['attributes']))$R034AE2AB94F99CC81B389A1822DA3353 .= '(' . $RB3F07F8C3658A835940E88288B58F707['attributes'] . ')';        $R034AE2AB94F99CC81B389A1822DA3353 .= '<br />';       }      }     }    }    return $R034AE2AB94F99CC81B389A1822DA3353;   }     public function hookDisplayCarrierList($RC2D2567438B1F39DD71F78195B5F3DED)   {    if(!$this->active)return;    $RB5A267A267B41CB2526032F545CB3B9D = AgileHelper::getPageName();    if($RB5A267A267B41CB2526032F545CB3B9D=='order.php')    {     if(_PS_VERSION_ > '1.5')      Context::getContext()->controller->addJS(_THEME_JS_DIR_.'cart-summary.js');     else      Tools::addJS(_THEME_JS_DIR_.'cart-summary.js');    }        $RD9F407E6E21C8FDE362E9F35A903B893 = $this->context->cart->getProducts(false);    if(!isset($RD9F407E6E21C8FDE362E9F35A903B893) OR empty($RD9F407E6E21C8FDE362E9F35A903B893))return;    $R3CA092FF89E1C9FFB12399030355F8FC = SellerShipping::getZoneID($this->context->cart->id_address_delivery, $this->context->cart->id_customer);    for($R5B92E56774920499F4ADDD0EC782C83E=0;$R5B92E56774920499F4ADDD0EC782C83E<count($RD9F407E6E21C8FDE362E9F35A903B893);$R5B92E56774920499F4ADDD0EC782C83E++)    {     $R40095968F29813E02A981F327827F17B = intval($RD9F407E6E21C8FDE362E9F35A903B893[$R5B92E56774920499F4ADDD0EC782C83E]['id_product']);     $REDFEC30A90E80DFAD993E56F628914D4 = intval($RD9F407E6E21C8FDE362E9F35A903B893[$R5B92E56774920499F4ADDD0EC782C83E]['id_product_attribute']);     $R22AC9E3C2EE714BEF680E5CB5C8B74C1 = intval($RD9F407E6E21C8FDE362E9F35A903B893[$R5B92E56774920499F4ADDD0EC782C83E]['quantity']);     $R29E86421AF7E81568F7C79AE872A9AE6 = SellerShipping::getAvailableCarriers($R3CA092FF89E1C9FFB12399030355F8FC,$R40095968F29813E02A981F327827F17B,$R22AC9E3C2EE714BEF680E5CB5C8B74C1,$REDFEC30A90E80DFAD993E56F628914D4);       $R2E2977D422FE1730DB510A5E4DB447D6 = SellerShipping::getCarrierIDbyProductID($this->context->cart->id, $R40095968F29813E02A981F327827F17B, $REDFEC30A90E80DFAD993E56F628914D4);     $RE478A465A5C815CCA415BC9427F69B62 = $this->first_or_default_carrier($R2E2977D422FE1730DB510A5E4DB447D6, $R29E86421AF7E81568F7C79AE872A9AE6);     $R0746B86CA0C0ECC40828F7387676C870 = 0;     $RD9F407E6E21C8FDE362E9F35A903B893[$R5B92E56774920499F4ADDD0EC782C83E]['is_pickupcenter'] = 0;     if(Module::isInstalled('agilepickupcenter') && $R2E2977D422FE1730DB510A5E4DB447D6 == intval(Configuration::getGlobalValue('AGILE_PICKUPCENTER_CARRIER_ID')))      {          $R0BAAB7342C9E1F530967262708CDDCBB = SellerShipping::get_carrier_product_locations($this->context->cart->id,$R40095968F29813E02A981F327827F17B,$R2E2977D422FE1730DB510A5E4DB447D6);      if(count($R0BAAB7342C9E1F530967262708CDDCBB) > 0)       {       $RD9F407E6E21C8FDE362E9F35A903B893[$R5B92E56774920499F4ADDD0EC782C83E]['is_pickupcenter'] = 1;       $R0746B86CA0C0ECC40828F7387676C870=$this->first_or_default_location($R0BAAB7342C9E1F530967262708CDDCBB);       $RD9F407E6E21C8FDE362E9F35A903B893[$R5B92E56774920499F4ADDD0EC782C83E]['pickupLocations'] = $R0BAAB7342C9E1F530967262708CDDCBB;             }      $RD9F407E6E21C8FDE362E9F35A903B893[$R5B92E56774920499F4ADDD0EC782C83E]['id_location_selected'] = $R0746B86CA0C0ECC40828F7387676C870;      $RD9F407E6E21C8FDE362E9F35A903B893[$R5B92E56774920499F4ADDD0EC782C83E]['id_carrier'] = $R2E2977D422FE1730DB510A5E4DB447D6;     }     if(count($R29E86421AF7E81568F7C79AE872A9AE6) >0 AND (int)$R2E2977D422FE1730DB510A5E4DB447D6 != (int)$RE478A465A5C815CCA415BC9427F69B62)     {      $R2E2977D422FE1730DB510A5E4DB447D6 =  $RE478A465A5C815CCA415BC9427F69B62;       SellerShipping::updateCartCarrierForProduct($this->context->cart->id,$R40095968F29813E02A981F327827F17B,$REDFEC30A90E80DFAD993E56F628914D4,$R2E2977D422FE1730DB510A5E4DB447D6,$R0746B86CA0C0ECC40828F7387676C870);     }     $RD9F407E6E21C8FDE362E9F35A903B893[$R5B92E56774920499F4ADDD0EC782C83E]['sellercarriers'] = $R29E86421AF7E81568F7C79AE872A9AE6;     $RD9F407E6E21C8FDE362E9F35A903B893[$R5B92E56774920499F4ADDD0EC782C83E]['sellercarrier_selected'] = $R2E2977D422FE1730DB510A5E4DB447D6;    }      $this->context->smarty->assign(array(     'cartproducts'=>$RD9F407E6E21C8FDE362E9F35A903B893     ,'is_at_order_opc' => ($RB5A267A267B41CB2526032F545CB3B9D=='order-opc.php'?1:0)     ,'image_size' => (_PS_VERSION_>'1.5.1' ? 'medium_default' : 'medium')     ,'id_cart_sellershipping' => $this->context->cart->id     ));      Context::getContext()->controller->addCSS($this->_path.'css/agilesellersshipping.css', 'all');;      return $this->display(__FILE__, '/views/templates/hook/hookextracarrier.tpl');   }       private function first_or_default_carrier($R6309A39D7A3F692C93A4BA098327FC43, $RE1B2B3167E624F30E44FB480AE7FA500)   {    if(empty($RE1B2B3167E624F30E44FB480AE7FA500))return $R6309A39D7A3F692C93A4BA098327FC43;    foreach($RE1B2B3167E624F30E44FB480AE7FA500 as $R53CED8F460F10F938CCEC04FE634E4D3)    {     if(intval($R6309A39D7A3F692C93A4BA098327FC43) == (int)$R53CED8F460F10F938CCEC04FE634E4D3['id_carrier'])return $R6309A39D7A3F692C93A4BA098327FC43;    }    return (int)$RE1B2B3167E624F30E44FB480AE7FA500[0]['id_carrier'];   }         public function displayInfoByCart($RF50CDD3F2AACFD3098534F1C052C25BE)   {    $RC2D2567438B1F39DD71F78195B5F3DED = array();    $RC2D2567438B1F39DD71F78195B5F3DED['id_cart'] = $RF50CDD3F2AACFD3098534F1C052C25BE;    if(isset($this->context->cookie->profile) AND $this->context->cookie->profile == Configuration::get('AGILE_MS_PROFILE_ID'))     $RC2D2567438B1F39DD71F78195B5F3DED['id_seller'] = intval($this->context->cookie->id_employee);        return $this->hookCarrierTotalSummary($RC2D2567438B1F39DD71F78195B5F3DED);   }      public function hookActionCartSave($RC2D2567438B1F39DD71F78195B5F3DED)   {    if(!$this->active)return;    if(!isset($RC2D2567438B1F39DD71F78195B5F3DED['cart']))return;    SellerShipping::cleanCartCarrier(isset($RC2D2567438B1F39DD71F78195B5F3DED['cart'])?$RC2D2567438B1F39DD71F78195B5F3DED['cart']->id : 0);       }         public function hookActionCarrierUpdate($RC2D2567438B1F39DD71F78195B5F3DED)   {    if(!$this->active)return;      $RAB57CDF9D0112600945C675196EC7DA0 = Carrier::getActiveIDByID(Configuration::get('AGILE_SS_CARRIER_ID'));;    if($RAB57CDF9D0112600945C675196EC7DA0 == 0)$RAB57CDF9D0112600945C675196EC7DA0 = $this->createLinkedCarrier();    Configuration::updateValue('AGILE_SS_CARRIER_ID', $RAB57CDF9D0112600945C675196EC7DA0);     }         public function createLinkedCarrier()   {    $R53CED8F460F10F938CCEC04FE634E4D3 = new Carrier();    $R53CED8F460F10F938CCEC04FE634E4D3->id = 0;    $R53CED8F460F10F938CCEC04FE634E4D3->id_tax_rules_group = 0;    $R53CED8F460F10F938CCEC04FE634E4D3->need_range = 1;    $R53CED8F460F10F938CCEC04FE634E4D3->external_module_name = $this->name;    $R53CED8F460F10F938CCEC04FE634E4D3->shipping_external = 0;    $R53CED8F460F10F938CCEC04FE634E4D3->name = $this->l('Seller Default Carrier');    $R53CED8F460F10F938CCEC04FE634E4D3->url = '';    $R53CED8F460F10F938CCEC04FE634E4D3->active = 1;    $R53CED8F460F10F938CCEC04FE634E4D3->deleted = 0;    $R53CED8F460F10F938CCEC04FE634E4D3->shipping_handling = 0;    $R53CED8F460F10F938CCEC04FE634E4D3->range_behavior = 0;    $R53CED8F460F10F938CCEC04FE634E4D3->is_module = 1;         $RE4383934787B83B49DDB150913CF42D2 = Language::getLanguages();    foreach ($RE4383934787B83B49DDB150913CF42D2 AS $R739F6542BB76E1DDEC494F839F85A06E)    {     $RB0D5D47F3D2E32A124C14253ABA3976A = array('delay');     foreach($RB0D5D47F3D2E32A124C14253ABA3976A AS $R4454E360FFF252043E577C8411615F0E)      $R53CED8F460F10F938CCEC04FE634E4D3->{$R4454E360FFF252043E577C8411615F0E}[intval($R739F6542BB76E1DDEC494F839F85A06E['id_lang'])] = $this->l('Default Delivery for all sellers');    }    try    {     $R53CED8F460F10F938CCEC04FE634E4D3->add();    }    catch(Exception $R0D54236DA20594EC13FC81B209733931)    {     die($R0D54236DA20594EC13FC81B209733931->getMessage());    }          Db::getInstance()->Execute('DELETE FROM '._DB_PREFIX_.'carrier_group WHERE id_carrier='.intval($R53CED8F460F10F938CCEC04FE634E4D3->id));    $RB67F4F4FC0A88900A925BA14A75BBE2B = Db::getInstance()->ExecuteS('SELECT id_group FROM `'._DB_PREFIX_.'group`');    foreach ($RB67F4F4FC0A88900A925BA14A75BBE2B as $R87AEE2288494E53FB8611A590D3512AC)    {     Db::getInstance()->Execute('INSERT INTO '._DB_PREFIX_.'carrier_group (id_group, id_carrier) VALUES('.intval($R87AEE2288494E53FB8611A590D3512AC['id_group']).','.$R53CED8F460F10F938CCEC04FE634E4D3->id.')');    }      $RE5D918B5A95D7667BA4C88872B4ABD3A = Zone::getZones(true);    foreach ($RE5D918B5A95D7667BA4C88872B4ABD3A as $R65D0BDE1CE365AF7E94B8D0C9775D247)    {     $R53CED8F460F10F938CCEC04FE634E4D3->addZone($R65D0BDE1CE365AF7E94B8D0C9775D247['id_zone']);    }    return $R53CED8F460F10F938CCEC04FE634E4D3->id;   }      public static function override_carriers()   {    $RB10E8575D7A5B4C417D9DCF8D6BC17BE = Context::getContext();      $R0ACBF3334E5196BD6BFD3ADC13786C4C = (int)Configuration::get('AGILE_SS_CARRIER_ID');    $RB10E8575D7A5B4C417D9DCF8D6BC17BE->smarty->assign(array(     'checked' => $R0ACBF3334E5196BD6BFD3ADC13786C4C,     'default_carrier' => $R0ACBF3334E5196BD6BFD3ADC13786C4C     ));   }      public function hookPickupLocations($RC2D2567438B1F39DD71F78195B5F3DED)   {    if(!$this->active)return;    $RF50CDD3F2AACFD3098534F1C052C25BE = $RC2D2567438B1F39DD71F78195B5F3DED['id_cart'];      $R0ACBF3334E5196BD6BFD3ADC13786C4C=$RC2D2567438B1F39DD71F78195B5F3DED['id_carrier'];;    $R40095968F29813E02A981F327827F17B = $RC2D2567438B1F39DD71F78195B5F3DED['id_product'];    $REDFEC30A90E80DFAD993E56F628914D4 = $RC2D2567438B1F39DD71F78195B5F3DED['id_product_attribute'];    $R0746B86CA0C0ECC40828F7387676C870 = intval($RC2D2567438B1F39DD71F78195B5F3DED['id_location']);    if(!$RF50CDD3F2AACFD3098534F1C052C25BE)return;        include_once(_PS_ROOT_DIR_  . "/modules/agilesellershipping/SellerShipping.php");    include_once(_PS_ROOT_DIR_  . "/modules/agilemultipleseller/agilemultipleseller.php");    $R996C30A3573BB68AFD6EA613086EF8AA = true;      $R4C40966EA8337EFDF326315499413376 = AgileMultipleSeller::getSellersByCart($RF50CDD3F2AACFD3098534F1C052C25BE);    if(empty($R4C40966EA8337EFDF326315499413376)) return;    $R0BAAB7342C9E1F530967262708CDDCBB = SellerShipping::get_carrier_product_locations($RF50CDD3F2AACFD3098534F1C052C25BE,$R40095968F29813E02A981F327827F17B,$R0ACBF3334E5196BD6BFD3ADC13786C4C);    if(count($R0BAAB7342C9E1F530967262708CDDCBB) >0 && $R0746B86CA0C0ECC40828F7387676C870 == 0)     {     $R0746B86CA0C0ECC40828F7387676C870 = $R0BAAB7342C9E1F530967262708CDDCBB[0]['id_location'];    }    $this->context->smarty->assign(array(     'pickupLocations' => $R0BAAB7342C9E1F530967262708CDDCBB     ,'id_location_selected' =>  $R0746B86CA0C0ECC40828F7387676C870     ,'id_cart' => $RF50CDD3F2AACFD3098534F1C052C25BE     ,'id_product' => $R40095968F29813E02A981F327827F17B     ,'id_product_attribute' => $REDFEC30A90E80DFAD993E56F628914D4     ,'id_carrier' => $R0ACBF3334E5196BD6BFD3ADC13786C4C     ));    return $this->display(__FILE__, '/views/templates/hook/pickuplocations.tpl');   }   private function first_or_default_location($RBD77092B249DD66EF0B009A46427535F)   {    if(empty($RBD77092B249DD66EF0B009A46427535F))return 0;    foreach($RBD77092B249DD66EF0B009A46427535F as $RAE94F1F0304E14D2AFEE5B99285CBB58)    {     if($RAE94F1F0304E14D2AFEE5B99285CBB58['id_location_selected']>0)return $RAE94F1F0304E14D2AFEE5B99285CBB58['id_location_selected'];    }    return (int)$RBD77092B249DD66EF0B009A46427535F[0]['id_location'];   }     public function getContent()   {    $this->_html = '<h2>'.$this->displayName.'</h2>';        $R0E50532F705BA890C56DC90FC3472539 = AgileInstaller::detect_admin_folder($_SERVER['SCRIPT_FILENAME']);    $R5A0E1B3F4DE39462E7CECCA34A34D7E1 = AgileInstaller::install_health_check($this->newfiles, $this->name, $R0E50532F705BA890C56DC90FC3472539);    if(!empty($R5A0E1B3F4DE39462E7CECCA34A34D7E1)) $this->_html .= $R5A0E1B3F4DE39462E7CECCA34A34D7E1;        $this->_html .= AgileInstaller::show_agile_links();    if (Tools::isSubmit('submitSetting'))    {        $RC8835E30C6A01D78924D17FA5FC44DBA = intval(Tools::getValue('carrier_id'));     if (!$RC8835E30C6A01D78924D17FA5FC44DBA)      $this->_postErrors[] = '<div class="alert error">'.$this->l('You should select the "Linked Carrier " field').'</div>';       if (!sizeof($this->_postErrors))     {      Configuration::updateValue('AGILE_SS_CARRIER_ID', intval($RC8835E30C6A01D78924D17FA5FC44DBA));      Configuration::updateValue('AGILE_SS_AS_DEFAULT_CARRIER', intval(Tools::getValue('as_default_carrier')));      Db::getInstance()->Execute('UPDATE  `'._DB_PREFIX_.'carrier` SET is_module=1 WHERE id_carrier=' .$RC8835E30C6A01D78924D17FA5FC44DBA);      $this->displayConf();              }              else      $this->displayErrors();                   }                  $this->displayForm();    return $this->_html;   }     public function displayConf()   {    $this->_html .= $this->displayConfirmation($this->l('Settings updated'));   }     public function displayForm()   {       $RC8835E30C6A01D78924D17FA5FC44DBA = intval(Configuration::get('AGILE_SS_CARRIER_ID'));                 $R53CED8F460F10F938CCEC04FE634E4D3 = new Carrier(intval(Configuration::get('AGILE_SS_CARRIER_ID')));              $R126B270B98D21D42809A28EA267BE16A = Tab::getIdFromClassName('AdminCarriers');    $R80B00A5BE493981262D9DE29642139CB = Tools::getAdminToken('AdminCarriers' .intval($R126B270B98D21D42809A28EA267BE16A).intval($this->context->cookie->id_employee));          $RE1B2B3167E624F30E44FB480AE7FA500= array(     array('id'=> AgileSellerShipping::USE_DEFAULT_CARRIER_WHEN_NO_CARRIERS, 'name' => $this->l('Yes, only when no other carriers available for the seller')),     array('id'=> AgileSellerShipping::USE_DEFAULT_CARRIER_ALWAYS, 'name' => $this->l('Yes, always use this carrier for all sellers')),    );       $RD05A28496998D5D330106BBAE629B948 = array(     'form' => array(      'legend' => array(       'title' => $this->l('Settings'),       'image' => $this->_path.'logo.gif',      ),      'description' => '<span style="color:red">' . $this->l('Please read instruction first.') . ' </span><br>' .       $this->l('A new carrier named "agilesellershipping" has been created and Linked to this module.')      ,      'input' => array(       array(        'type' => 'hidden',        'label' => $this->l('Linked Carrier ID'),        'name' => 'carrier_id',       ),       array(        'type' => 'text',        'size' => 80,        'readonly' => 1,        'label' => $this->l('Linked Carrier'),        'name' => 'carriername',       ),       array(        'type' => 'comment',        'label' => $this->l('Maintenance Notes'),        'name' => 'maintenance',        'desc' => array(         $this->l('1. Please change settings for this carrier as you would any other Carrier in the back office Admin tab: "Shipping"->"Carriers"') . '&nbsp;<a href="./index.php?tab=AdminCarriers&token=' . $R80B00A5BE493981262D9DE29642139CB . '" style="color:Blue;text-decoration:underline;">' . $this->l('Click here')  . '</a>',         '<span style="color:red">' . $this->l('2. Please DO NOT DELETE this carrier') . '</span>',         $this->l('3. Please create price range or weight range and set the shipping fees for this carrier as you would any other carrier.')        )       ),       array(        'type' => 'select',        'label' => $this->l('Use Default Carrier'),        'name' => 'as_default_carrier',        'options' => array(         'query' => $RE1B2B3167E624F30E44FB480AE7FA500,         'id' => 'id',         'name' => 'name'        ),        'desc' => $this->l('Default carrier is the carrier created by this module and linked to this moduule')       )      ),      'submit' => array(       'title' => $this->l('Save'),      )     )    );    $R3A1E73211A105E82A8C89F8C8E3C8264 = new HelperForm();    $R3A1E73211A105E82A8C89F8C8E3C8264->show_toolbar = false;    $R3A1E73211A105E82A8C89F8C8E3C8264->table =  $this->name;    $R51C716B9664B3F4E109066C05B9B1A86 = new Language((int)Configuration::get('PS_LANG_DEFAULT'));    $R3A1E73211A105E82A8C89F8C8E3C8264->default_form_language = $R51C716B9664B3F4E109066C05B9B1A86->id;    $R3A1E73211A105E82A8C89F8C8E3C8264->module = $this;    $R3A1E73211A105E82A8C89F8C8E3C8264->allow_employee_form_lang = Configuration::get('PS_BO_ALLOW_EMPLOYEE_FORM_LANG') ? Configuration::get('PS_BO_ALLOW_EMPLOYEE_FORM_LANG') : 0;    $R3A1E73211A105E82A8C89F8C8E3C8264->identifier = $this->identifier;    $R3A1E73211A105E82A8C89F8C8E3C8264->submit_action = 'submitSetting';    $R3A1E73211A105E82A8C89F8C8E3C8264->currentIndex = $this->context->link->getAdminLink('AdminModules', false).'&configure='.$this->name.'&tab_module='.$this->tab.'&module_name='.$this->name;    $R3A1E73211A105E82A8C89F8C8E3C8264->token = Tools::getAdminTokenLite('AdminModules');    $R3A1E73211A105E82A8C89F8C8E3C8264->tpl_vars = array(     'fields_value' => $this->getConfigFieldsValues($R53CED8F460F10F938CCEC04FE634E4D3),     'languages' => $this->context->controller->getLanguages(),     'id_language' => $this->context->language->id    );      $this->_html .=  $R3A1E73211A105E82A8C89F8C8E3C8264->generateForm(array($RD05A28496998D5D330106BBAE629B948));   }     public function getConfigFieldsValues($R53CED8F460F10F938CCEC04FE634E4D3)   {    return array(     'as_default_carrier' => Tools::getValue('as_default_carrier', intval(Configuration::get('AGILE_SS_AS_DEFAULT_CARRIER'))),     'carriername' => $R53CED8F460F10F938CCEC04FE634E4D3->name . "(ID:" . $R53CED8F460F10F938CCEC04FE634E4D3->id . ")",     'carrier_id' => $R53CED8F460F10F938CCEC04FE634E4D3->id    );   }     public function displayErrors()   {    $R5E535DBA6BC26B2ECEEF3DA589516785 = sizeof($this->_postErrors);    $this->_html .= '    <div class="module_error alert alert-danger">     <h3>'.($R5E535DBA6BC26B2ECEEF3DA589516785 > 1 ? $this->l('There are') : $this->l('There is')).' '.$R5E535DBA6BC26B2ECEEF3DA589516785.' '.($R5E535DBA6BC26B2ECEEF3DA589516785 > 1 ? $this->l('errors') : $this->l('error')).'</h3>     <ol>';    foreach ($this->_postErrors AS $RB5ADDE8D7D7412251F47419FE9BF51A7)     $this->_html .= '<li>'.$RB5ADDE8D7D7412251F47419FE9BF51A7.'</li>';    $this->_html .= '     </ol>    </div>';   }        }  