<?php
///-build_id: 2016030721.4219
/// This source file is subject to the Software License Agreement that is bundled with this 
/// package in the file license.txt, or you can get it here
/// http://addons-modules.com/en/content/3-terms-and-conditions-of-use
///
/// @copyright  2009-2012 Addons-Modules.com
///  If you need open code to customize or merge code with othe modules, please contact us.
define('AgileAdaptive_Logging', 'off');
class AgilePaypalAdaptive extends PaymentModule
{
	public static $PaymentCollectionMode = array(
		1 => true				,2 => true				,3 => true				);
	
	const ADAPTIVE_STYLE_PARALLEL = 0;
	const ADAPTIVE_STYLE_CHAINED = 1;

	const INSTALL_SQL_FILE = 'install.sql';

	private $version_dependencies = array();

	private	$_html = '';
	private $_postErrors = array();

	public function __construct()   {    $this->name = 'agilepaypaladaptive';    $this->isAgileKernelCompatible = true;    $this->author = 'addons-modules.com';       $this->tab = 'payments_gateways';    $this->version = '2.5.0.1';    $this->ps_versions_compliancy = array('min' => '1.6', 'max' => '1.7');    $this->dependencies = array( 'agilemultipleseller','agilesellercommission','agilekernel');    $this->version_dependencies = array('agilemultipleseller' => '3.3.0.1', 'agilesellercommission' => '2.5.0.1','agilekernel'=>'1.0.0.1');     $this->newfiles = array();        $this->is_eu_compatible = 1;    $this->currencies = true;    $this->currencies_mode = 'radio';            parent::__construct();      $this->page = basename(__FILE__, '.php');          $this->displayName = $this->l('Agile Paypal Adaptive payment module');          $this->description = $this->l('Accepts payments by PayPal Adaptive payment, one sender / multiple receivers');    $this->confirmUninstall = $this->l('Are you sure you want to delete your details ?');    if (Configuration::get('AGILE_PAYPALAD_BUSINESS') == 'paypal@prestashop.com')     $this->warning = $this->l('You are currently using the default PayPal email address, you need to use your own email address');    if ($_SERVER['SERVER_NAME'] == 'localhost')     $this->warning = $this->l('Your are in localhost mode, PayPal cannot validate order');   }     public function getPaypalUrl()   {       if(Configuration::get('AGILE_PAYPALAD_SANDBOX'))     return 'https://www.sandbox.paypal.com/webscr';       else           return 'https://www.paypal.com/webscr';   }      public function getPaypalServiceEndpoint()      {       if(Configuration::get('AGILE_PAYPALAD_SANDBOX'))              return 'https://svcs.sandbox.paypal.com/';          else              return 'https://svcs.paypal.com/';       }         public function install()   {    if(!Module::isInstalled('agilekernel'))    {     $this->_errors[] = $this->l('You have to install Agile Kernel module before installing this module. The download link of this module should have been included your download email for your order. If you can not find it, please request by email to support@addons-modules.com with your order #.');     return false;    }          if(!defined('_IS_AGILE_DEV_') && !empty($this->newfiles) && !Tools::getValue("redirected"))    {     $R0E50532F705BA890C56DC90FC3472539 = AgileInstaller::detect_admin_folder($_SERVER['SCRIPT_FILENAME']);     AgileInstaller::install_newfiles($this->newfiles, $this->name, $R0E50532F705BA890C56DC90FC3472539, 2);     $R679E9B9234E2062F809DBD3325D37FB6 = AgileInstaller::install_health_check($this->newfiles, $this->name, $R0E50532F705BA890C56DC90FC3472539);      if(!empty($R679E9B9234E2062F809DBD3325D37FB6))     {      $this->_errors[] = '<a target="agile" style="text-decoration:underline;color:blue;" href="http://addons-modules.com/store/en/content/36-agile-module-installation-tips">' .       $this->l('Failed to update files due to permission issue, please visit here for more instructions.') . '</a>';      return false;     }     Tools::redirectAdmin("./index.php?controller=AdminModules&token=" . Tools::getValue("token") . "&install=" . $this->name . "&tab_module=" .$this->tab ." &module_name=" . $this->name . "&anchor=anchor" . $this->name . "&redirected=1");    }      $R24DD45B1C43192100CB0BCF98D0AEF9C = AgileInstaller::version_depencies($this->version_dependencies);    if(!empty($R24DD45B1C43192100CB0BCF98D0AEF9C)){     $this->_errors = array_merge($this->_errors, $R24DD45B1C43192100CB0BCF98D0AEF9C);     return false;    }            if(!AgileInstaller::sql_install(dirname(__FILE__).'/'.self::INSTALL_SQL_FILE))              return false;      if (!parent::install()     OR !Configuration::updateValue('AGILE_PAYPALAD_BUSINESS', 'paypal@prestashop.com')     OR !Configuration::updateValue('AGILE_PAYPALAD_SANDBOX', 1)     OR !Configuration::updateValue('AGILE_PAYPALAD_API_USERNAME', '')     OR !Configuration::updateValue('AGILE_PAYPALAD_API_PASSWORD', '')     OR !Configuration::updateValue('AGILE_PAYPALAD_API_SIGNATURE', '')     OR !Configuration::updateValue('AGILE_PAYPALAD_APPLICATION_ID', 'APP-80W284485P519543T')     OR !Configuration::updateValue('AGILE_PAYPALAD_PAYSTYLE', 0)     OR !$this->registerHook('displayHeader')     OR !$this->registerHook('displayPayment')     OR !$this->registerHook('displayPaymentEU')     OR !$this->registerHook('displayPaymentReturn')     OR !$this->registerHook('actionAgilePaymentModuleIntegrate')    )return false;      if(!AgileInstaller::create_tab('Adaptive Payment Logs','AgileAdaptiveLogs',(_PS_VERSION_ > '1.5'?'AdminParentCustomer':'AdminCustomers'),$this->name))return false;    AgileInstaller::init_tab_prmission_for_existing_profiles('AgileAdaptiveLogs',1,1,1,1);        Db::getInstance()->Execute('UPDATE ' . _DB_PREFIX_ . 'agilepaypaladaptive_txndetail SET record_type=3 WHERE record_type=0');        if(version_compare(_PS_VERSION_, '1.5', '>='))Autoload::getInstance()->generateIndex();      return true;   }      public function uninstall()   {       if(!parent::uninstall())return false;      AgileInstaller::delete_tab('AgileAdaptiveLogs');                        return true;   }     public function getContent()   {    $this->_html = '<h2>'.$this->displayName.'</h2>';        $R0E50532F705BA890C56DC90FC3472539 = AgileInstaller::detect_admin_folder($_SERVER['SCRIPT_FILENAME']);    $R5A0E1B3F4DE39462E7CECCA34A34D7E1 = AgileInstaller::install_health_check($this->newfiles, $this->name, $R0E50532F705BA890C56DC90FC3472539);    if(!empty($R5A0E1B3F4DE39462E7CECCA34A34D7E1)) $this->_html .= $R5A0E1B3F4DE39462E7CECCA34A34D7E1;            $this->_html .= AgileInstaller::show_agile_links();    if (isset($_POST['submitPaypal']))    {        $R5C56A42C3A509ED8D4ED17B6BBD03121 = Tools::getValue('business');        $RFEC144236AC9EE9FEEF818A60D092A85 = Tools::getValue('api_username');        $R425FB9969B1ED0CC5D6CB1911C1D5B11 = Tools::getValue('api_password');        $RAD6101F8BBF7F20F5D38E9F99CAE148B = Tools::getValue('api_signature');        $RED712980DEAE5AC7FE765059C0B78D14= Tools::getValue('application_id');         if (empty($R5C56A42C3A509ED8D4ED17B6BBD03121))      $this->_postErrors[] = $this->l('Paypal business e-mail address is required.');     elseif (!Validate::isEmail($R5C56A42C3A509ED8D4ED17B6BBD03121))      $this->_postErrors[] = $this->l('Paypal business must be an e-mail address.');     elseif (empty($RFEC144236AC9EE9FEEF818A60D092A85))      $this->_postErrors[] = $this->l('Paypal API username is required.');     elseif (empty($R425FB9969B1ED0CC5D6CB1911C1D5B11))      $this->_postErrors[] = $this->l('Paypal API password is required.');     elseif (empty($R425FB9969B1ED0CC5D6CB1911C1D5B11))      $this->_postErrors[] = $this->l('Paypal API signature is required.');     elseif (empty($RED712980DEAE5AC7FE765059C0B78D14))      $this->_postErrors[] = $this->l('Application ID is required.');     if (!isset($_POST['sandbox']))      $_POST['sandbox'] = 1;     if (!isset($_POST['paystyle']))      $_POST['paystyle'] = 1;       if (!sizeof($this->_postErrors))     {      Configuration::updateValue('AGILE_PAYPALAD_BUSINESS', $R5C56A42C3A509ED8D4ED17B6BBD03121);      Configuration::updateValue('AGILE_PAYPALAD_API_USERNAME', $RFEC144236AC9EE9FEEF818A60D092A85);      Configuration::updateValue('AGILE_PAYPALAD_API_PASSWORD', $R425FB9969B1ED0CC5D6CB1911C1D5B11);      Configuration::updateValue('AGILE_PAYPALAD_API_SIGNATURE', $RAD6101F8BBF7F20F5D38E9F99CAE148B);      Configuration::updateValue('AGILE_PAYPALAD_APPLICATION_ID', $RED712980DEAE5AC7FE765059C0B78D14);      Configuration::updateValue('AGILE_PAYPALAD_SANDBOX', intval($_POST['sandbox']));      Configuration::updateValue('AGILE_PAYPALAD_PAYSTYLE', intval($_POST['paystyle']));      $this->displayConf();     }     else      $this->displayErrors();    }      $this->displayFormSettings();    return $this->_html;   }     public function displayConf()   {    $this->_html .= '    <div class="conf confirm">     '.$this->l('Settings updated').'    </div>';   }     public function displayErrors()   {    $R5E535DBA6BC26B2ECEEF3DA589516785 = sizeof($this->_postErrors);    $this->_html .= '    <div class="alert error">     <h3>'.($R5E535DBA6BC26B2ECEEF3DA589516785 > 1 ? $this->l('There are') : $this->l('There is')).' '.$R5E535DBA6BC26B2ECEEF3DA589516785.' '.($R5E535DBA6BC26B2ECEEF3DA589516785 > 1 ? $this->l('errors') : $this->l('error')).'</h3>     <ol>';    foreach ($this->_postErrors AS $RB5ADDE8D7D7412251F47419FE9BF51A7)     $this->_html .= '<li>'.$RB5ADDE8D7D7412251F47419FE9BF51A7.'</li>';    $this->_html .= '     </ol>    </div>';   }      public function displayFormSettings()   {    $RBAAA917A11E347C49C3462A9383AE5BD = Configuration::getMultiple(array('AGILE_PAYPALAD_BUSINESS', 'AGILE_PAYPALAD_SANDBOX','AGILE_PAYPALAD_API_USERNAME','AGILE_PAYPALAD_API_PASSWORD','AGILE_PAYPALAD_API_SIGNATURE','AGILE_PAYPALAD_APPLICATION_ID','AGILE_PAYPALAD_PAYSTYLE'));    $R5C56A42C3A509ED8D4ED17B6BBD03121 = array_key_exists('business', $_POST) ? $_POST['business'] : (array_key_exists('AGILE_PAYPALAD_BUSINESS', $RBAAA917A11E347C49C3462A9383AE5BD) ? $RBAAA917A11E347C49C3462A9383AE5BD['AGILE_PAYPALAD_BUSINESS'] : '');    $RFEC144236AC9EE9FEEF818A60D092A85 = array_key_exists('api_username', $_POST) ? $_POST['api_username'] : (array_key_exists('AGILE_PAYPALAD_API_USERNAME', $RBAAA917A11E347C49C3462A9383AE5BD) ? $RBAAA917A11E347C49C3462A9383AE5BD['AGILE_PAYPALAD_API_USERNAME'] : '');    $R425FB9969B1ED0CC5D6CB1911C1D5B11 = array_key_exists('api_password', $_POST) ? $_POST['api_password'] : (array_key_exists('AGILE_PAYPALAD_API_PASSWORD', $RBAAA917A11E347C49C3462A9383AE5BD) ? $RBAAA917A11E347C49C3462A9383AE5BD['AGILE_PAYPALAD_API_PASSWORD'] : '');    $RAD6101F8BBF7F20F5D38E9F99CAE148B = array_key_exists('api_signature', $_POST) ? $_POST['api_signature'] : (array_key_exists('AGILE_PAYPALAD_API_SIGNATURE', $RBAAA917A11E347C49C3462A9383AE5BD) ? $RBAAA917A11E347C49C3462A9383AE5BD['AGILE_PAYPALAD_API_SIGNATURE'] : '');    $RED712980DEAE5AC7FE765059C0B78D14 = array_key_exists('application_id', $_POST) ? $_POST['application_id'] : (array_key_exists('AGILE_PAYPALAD_APPLICATION_ID', $RBAAA917A11E347C49C3462A9383AE5BD) ? $RBAAA917A11E347C49C3462A9383AE5BD['AGILE_PAYPALAD_APPLICATION_ID'] : '');    $RDA59465C49B663D25A3EBB4BF89D35E5 = array_key_exists('sandbox', $_POST) ? $_POST['sandbox'] : (array_key_exists('AGILE_PAYPALAD_SANDBOX', $RBAAA917A11E347C49C3462A9383AE5BD) ? $RBAAA917A11E347C49C3462A9383AE5BD['AGILE_PAYPALAD_SANDBOX'] : '');    $R0BCF672444581AF33549415BA10C3787 = array_key_exists('paystyle', $_POST) ? $_POST['paystyle'] : (array_key_exists('AGILE_PAYPALAD_PAYSTYLE', $RBAAA917A11E347C49C3462A9383AE5BD) ? $RBAAA917A11E347C49C3462A9383AE5BD['AGILE_PAYPALAD_PAYSTYLE'] : '');      $RC91C47F484460FFE82CE832D44A8DA99 = Currency::getCurrencies();      $this->_html .= '    <form action="'.$_SERVER['REQUEST_URI'].'" method="post" style="clear: both;">    <fieldset>     <legend><img src="../img/admin/contact.gif" />'.$this->l('Settings').'</legend>     <label>'.$this->l('PayPal business e-mail').'</label>     <div class="margin-form"><input type="text" size="33" name="business" value="'.htmlentities($R5C56A42C3A509ED8D4ED17B6BBD03121, ENT_COMPAT, 'UTF-8').'" /></div>       <label>'.$this->l('Sandbox mode (Test)').'</label>     <div class="margin-form">      <input type="radio" name="sandbox" value="1" '.($RDA59465C49B663D25A3EBB4BF89D35E5 ? 'checked="checked"' : '').' /> <label class="t">'.$this->l('Yes').'</label>      <input type="radio" name="sandbox" value="0" '.(!$RDA59465C49B663D25A3EBB4BF89D35E5 ? 'checked="checked"' : '').' /> <label class="t">'.$this->l('No').'</label>     </div>       <label>'.$this->l('Pay Style').'</label>     <div class="margin-form">         <font color="red">'.$this->l('The below payment style setting is only valid when you set "Both Store and Seller collect payment" mode in the Multiple Seller module.').'</font><br />         <font color="red">'.$this->l('For any other payment collection modes, this module will automatically act accordingly.').'</font><br />      <input type="radio" name="paystyle" value="' . self::ADAPTIVE_STYLE_PARALLEL .'" '.(!$R0BCF672444581AF33549415BA10C3787 ? 'checked="checked"' : '').' /> <span class="t">'.$this->l('Parallel Payments').'</span> - <span>' . $this->l('Payer will see payment goes to Store and Sellers '). '</span><br />      <input type="radio" name="paystyle" value="' . self::ADAPTIVE_STYLE_CHAINED. '" '.($R0BCF672444581AF33549415BA10C3787 ? 'checked="checked"' : '').' /> <label class="t">'.$this->l('Chained Payments').'</label> - <span>' . $this->l('Payer will see payment goes to Store only, payer will not see payment between store and Sellers '). '</span>     </div>       <label>'.$this->l('PayPal API user name').'</label>     <div class="margin-form"><input type="text" size="33" name="api_username" value="'.htmlentities($RFEC144236AC9EE9FEEF818A60D092A85, ENT_COMPAT, 'UTF-8').'" /></div>       <label>'.$this->l('PayPal API password').'</label>     <div class="margin-form"><input type="text" size="33" name="api_password" value="'.htmlentities($R425FB9969B1ED0CC5D6CB1911C1D5B11, ENT_COMPAT, 'UTF-8').'" /></div>       <label>'.$this->l('PayPal API signature').'</label>     <div class="margin-form"><input type="text" size="83" name="api_signature" value="'.htmlentities($RAD6101F8BBF7F20F5D38E9F99CAE148B, ENT_COMPAT, 'UTF-8').'" /></div>       <label>'.$this->l('Application ID').'</label>     <div class="margin-form">         <input type="text" size="33" name="application_id" value="'.htmlentities($RED712980DEAE5AC7FE765059C0B78D14, ENT_COMPAT, 'UTF-8').'" />         <p class="clear">For sandbox testing, please set as APP-80W284485P519543T, for product mode, pleas use your own</p>     </div>     <font color="red">' . $this->l('Please Note'). '</font>              <p><ul>                  <li>' . $this->l('You need to apply an Paypal API Credential/Signture.').'&nbsp;<a style="color:Blue;" href="http://addons-modules.com/content/21-how-to-get-paypal-api-credential">' . $this->l('Click here for instructions on how to'). '</a></li>                  <li>' . $this->l('You need to obtain the Application ID from Paypal for Agile PrestaShop Adaptive Payment for your store.') . '&nbsp;<a style="color:Blue;" href="http://addons-modules.com/content/22-how-to-get-your-application-id-submit-your-application-">' . $this->l('Click here for instructions on how to'). '</a></li>               </ul></p>     <br /><center><input type="submit" name="submitPaypal" value="'.$this->l('Update settings').'" class="btn btn-primary" /></center>    </fieldset>    </form>    ';   }      public function hookDisplayHeader($RC2D2567438B1F39DD71F78195B5F3DED)   {    $this->context->controller->addCSS(_PS_ROOT_DIR_ . 'modules/agilepaypaladaptive/css/agilepaypaladaptive.css', 'all');    return false;         }        public function hookDisplayPayment($RC2D2567438B1F39DD71F78195B5F3DED)   {    if (!$this->active)     return ;      if(Module::isInstalled('agilemultipleseller'))    {        $RFA34F5AA68FB175F39407BC4D03FA3DD = (int)Configuration::get('AGILE_MS_PAYMENT_MODE');     if(!self::$PaymentCollectionMode[$RFA34F5AA68FB175F39407BC4D03FA3DD])return false;          $RF8AB79CB3F4E21B6B6CB6A743C481B21 = AgileSellerManager::seller_payment_uses($RC2D2567438B1F39DD71F78195B5F3DED['cart']->id, $this->name);        if($RFA34F5AA68FB175F39407BC4D03FA3DD != 3 && $RF8AB79CB3F4E21B6B6CB6A743C481B21 == 0)return false;    }          $R1063030E91FDD7F35BB4D8966ACE8FD2 = Tools::getShopDomainSsl(true,true) . __PS_BASE_URI__ . "modules/agilepaypaladaptive/redirect.php";    if(version_compare(_PS_VERSION_, '1.5', '>='))     $R1063030E91FDD7F35BB4D8966ACE8FD2 = Context::getContext()->link->getModuleLink('agilepaypaladaptive', 'redirect', array(), true);    $this->context->smarty->assign(array(      'agilepaypaladaptive_redirect_url' => $R1063030E91FDD7F35BB4D8966ACE8FD2      ));      return $this->display(__FILE__, 'views/templates/hook/payment.tpl');   }     public function hookDisplayPaymentEU($RC2D2567438B1F39DD71F78195B5F3DED)  {   if (!$this->active)    return;    $R938977A33ABE8FD2318B4D1938916FA0 = array(    'cta_text' => $this->l('Pay by Agile Paypal Adaptive'),    'logo' => Media::getMediaPath(dirname(__FILE__).'/agilepaypaladaptive.gif'),    'action' => $this->context->link->getModuleLink($this->name, 'reditect', array(), true)    );    return $R938977A33ABE8FD2318B4D1938916FA0;  }      public function hookDisplayPaymentReturn($RC2D2567438B1F39DD71F78195B5F3DED)   {    if (!$this->active)     return ;      return $this->display(__FILE__, 'confirmation.tpl');   }     public function hookShoppingCart($RC2D2567438B1F39DD71F78195B5F3DED)   {    if (!$this->active)     return ;             return $this->hookAgileExpressCheckout($RC2D2567438B1F39DD71F78195B5F3DED);   }        private function getPage()      {          $RB5A267A267B41CB2526032F545CB3B9D = $_SERVER["SCRIPT_NAME"];          $R5B92E56774920499F4ADDD0EC782C83E = strrpos($RB5A267A267B41CB2526032F545CB3B9D,"/");          $RB5A267A267B41CB2526032F545CB3B9D = strtolower(substr($RB5A267A267B41CB2526032F545CB3B9D,$R5B92E56774920499F4ADDD0EC782C83E+1));          return $RB5A267A267B41CB2526032F545CB3B9D;      }     public function getL($RF413F06AEBBCEF5E1C8B1019DEE6FE6B)   {    $R64D53A42404E0084D759965821B9824E = array(     'Currency Error' => $this->l('Invalid currency restriction setting for this payment module'),     'Seller Payment Info' => $this->l('Invalid seller payment information'),     'redirect_text' =>$this->l('Please wait, redirecting to Paypal... Thanks.'),     'cancel_text' =>$this->l('Cancel'),     'error title' => $this->l('Some errors occurred while preparing the payment'),     'Payment amount error'=> $this->l('Payment amount error'),          'mc_gross' => $this->l('Paypal key \'mc_gross\' not specified, can\'t control amount paid.'),     'payment_status' => $this->l('Paypal key \'payment_status\' not specified, can\'t control payment validity'),     'mc_currency' => $this->l('Paypal key \'mc_currency\' not specified, currency unknown'),     'cart' => $this->l('Cart not found'),     'order' => $this->l('Order has already been placed'),     'transaction' => $this->l('Paypal Transaction ID: '),     'verified' => $this->l('The PayPal transaction could not be VERIFIED.'),     'connect' => $this->l('Problem connecting to the PayPal server.'),     'nomethod' => $this->l('No communications transport available.'),     'socketmethod' => $this->l('Verification failure (using fsockopen). Returned: '),     'curlmethod' => $this->l('Verification failure (using cURL). Returned: '),     'curlmethodfailed' => $this->l('Connection using cURL failed'),     'Please wait, redirecting to Paypal... Thanks.' => $this->l('Please wait, redirecting to Paypal... Thanks.'),     'Sorry, we do not ship to your country.' => $this->l('Sorry, we do not ship to your country.'),     'Cancel' => $this->l('Cancel'),     'Paypal error: (invalid or undefined business account email)' => $this->l('Paypal error: (invalid or undefined business account email)'),     'Paypal error: (invalid address or customer)' => $this->l('Paypal error: (invalid address or customer)'),     'Seller payment email error' => $this->l('Seller payment email error: (Invalid or undefined seller business account email, please contact store administrator to correct it.)')    );    return $R64D53A42404E0084D759965821B9824E[$RF413F06AEBBCEF5E1C8B1019DEE6FE6B];   }     public function validateOrder($RF50CDD3F2AACFD3098534F1C052C25BE, $R58C4302894F48E8B96DCA49E94913761, $R6B4950513B552105C182A5C0BCA5DD87, $R80AB19B7D5C172F592843F8F29D4C8A2 = 'Unknown', $R157A6826A8BF1F36EBBE3DEC02351744 = NULL, $R6C814F60598DF94EC59E1793B925D1CB = array(), $R24BF50E0133D12E52620F5EA0A3DC353 = NULL, $R066CC1A9B859BBC5BEBEC00C275028F7 = false, $R1C9EAEF3B3A8C881E8210AAB82825DA8 = false, Shop $R7F0DA278AD542BC83DF932E4614E60C5 = null)   {    if (!$this->active)     return ;      parent::validateOrder($RF50CDD3F2AACFD3098534F1C052C25BE, $R58C4302894F48E8B96DCA49E94913761, $R6B4950513B552105C182A5C0BCA5DD87, $R80AB19B7D5C172F592843F8F29D4C8A2, $R157A6826A8BF1F36EBBE3DEC02351744, $R6C814F60598DF94EC59E1793B925D1CB, $R24BF50E0133D12E52620F5EA0A3DC353, $R066CC1A9B859BBC5BEBEC00C275028F7, $R1C9EAEF3B3A8C881E8210AAB82825DA8);   }         public function get_return_url()   {     if(version_compare(_PS_VERSION_, '1.5', '>='))     return Context::getContext()->link->getModuleLink('agilepaypaladaptive', 'return', array(), true);    else       return Tools::getShopDomainSsl(true,true) . __PS_BASE_URI__ . "modules/agilepaypaladaptive/paymentreturn.php";   }     public function process_payments()   {    global $paykey;          $R0EB1982D9BAA9716AC37A8F047D5800D = array();        $RF9F42DF316FBD92CB7F35D539398F40A = $this->getCurrency();    $R20537495E25245610B35404DC0DACF1C = new Currency($this->context->cart->id_currency);    if(!Validate::isLoadedObject($RF9F42DF316FBD92CB7F35D539398F40A) OR !Validate::isLoadedObject($R20537495E25245610B35404DC0DACF1C))    {     $R0EB1982D9BAA9716AC37A8F047D5800D[] = $this->getL('Currency Error');     return $R0EB1982D9BAA9716AC37A8F047D5800D;    }      $R70EBC679B0540EF4F29FBA398C611CB8 = 1;    if($R20537495E25245610B35404DC0DACF1C->id != $RF9F42DF316FBD92CB7F35D539398F40A->id)$R70EBC679B0540EF4F29FBA398C611CB8  = $RF9F42DF316FBD92CB7F35D539398F40A->conversion_rate / $R20537495E25245610B35404DC0DACF1C->conversion_rate;             $RE80E7E277859162E1FD60605013ACDD5 = intval(Configuration::get('AGILE_MS_PAYMENT_MODE'));    $R0BCF672444581AF33549415BA10C3787 = Configuration::get('AGILE_PAYPALAD_PAYSTYLE');    $RCC47177C2BA4149CFC455AC9C6225569 = ($RE80E7E277859162E1FD60605013ACDD5 == AgileMultipleseller::PAYMENT_MODE_BOTH &&              $R0BCF672444581AF33549415BA10C3787 == self::ADAPTIVE_STYLE_CHAINED);    $R66728EA03984F2F03C3BF2A2B650973F = AgileMultipleseller::get_payment_info_from_cart($RCC47177C2BA4149CFC455AC9C6225569);      $R66728EA03984F2F03C3BF2A2B650973F = $this->replaceEmailAddress($R66728EA03984F2F03C3BF2A2B650973F);        if(empty($R66728EA03984F2F03C3BF2A2B650973F))    {     $R0EB1982D9BAA9716AC37A8F047D5800D[] = $this->getL('Seller Payment Info');     return $R0EB1982D9BAA9716AC37A8F047D5800D;    }else    {     foreach($R66728EA03984F2F03C3BF2A2B650973F AS $R95909C49377A2B4F24C79D29C629AF65 =>  $R52FC1BA91D10F611E03D61C01C5F72EB)     {      if($R52FC1BA91D10F611E03D61C01C5F72EB['email'] == null OR strlen($R52FC1BA91D10F611E03D61C01C5F72EB['email']) <= 0)      {       return $R0EB1982D9BAA9716AC37A8F047D5800D[] = $this->getL('Seller payment email error');      }     }    }        $actionType = "PAY";     $feesPayer = 'EACHRECEIVER';     $currencyCode = $RF9F42DF316FBD92CB7F35D539398F40A->iso_code;       $R2924272E07CD66F7C098B71B2A4A164D = $_SERVER['SERVER_NAME'];    $R6D0389DD6B8C564D9F11504A8F6D9F40 = $_SERVER['SERVER_PORT'];    $R832073F8852D50E01E8499D01D6E06B7 = Tools::getHttpHost(true, true). __PS_BASE_URI__;    $REAB584130A980E541B44047E8875CED3 = $this->get_return_url();    $ipnNotificationUrl = $R832073F8852D50E01E8499D01D6E06B7."modules/" . $this->name ."/validation.php";    $R8A55C5948336F941C424DA53C0510D68 = Context::getContext()->link->getPageLink('order');       $preapprovalKey = '';    $senderEmail = '';    $R5833E3A8A6369DC080AEC0C5C218A954= array(     Pay::$actionType => $actionType,     Pay::$cancelUrl  => $R8A55C5948336F941C424DA53C0510D68,     Pay::$returnUrl=>   $REAB584130A980E541B44047E8875CED3,     Pay::$currencyCode  => $currencyCode,     Pay::$ipnNotificationUrl  => $ipnNotificationUrl,       Pay::$clientDetails_deviceId  => DEVICE_ID,     Pay::$clientDetails_ipAddress  => '127.0.0.1',     Pay::$clientDetails_applicationId =>Configuration::get('AGILE_PAYPALAD_APPLICATION_ID'),     RequestEnvelope::$requestEnvelopeErrorLanguage => 'en_US',     Pay::$feesPayer => $feesPayer    );      $R0CD215FF6A25E893125B761431830E1F = Configuration::get('AGILE_PAYPALAD_BUSINESS');      $RC0B91C945F317007CE0174BAC72E4286 = AgilePaypalAdaptiveTxn::getTxnByCartId($this->context->cart->id);     $R1FECDBE9D501D58782B557793BE3540C = new AgilePaypalAdaptiveTxn($RC0B91C945F317007CE0174BAC72E4286);    $R1FECDBE9D501D58782B557793BE3540C->id_cart = $this->context->cart->id;    $R1FECDBE9D501D58782B557793BE3540C->id_order = 0;    $R1FECDBE9D501D58782B557793BE3540C->payer_email = '';    $R1FECDBE9D501D58782B557793BE3540C->status = 'INIT';    $R1FECDBE9D501D58782B557793BE3540C->paymode = Configuration::get('AGILE_MS_PAYMENT_MODE');           $R1FECDBE9D501D58782B557793BE3540C->id_currency = $RF9F42DF316FBD92CB7F35D539398F40A->id;    $R1FECDBE9D501D58782B557793BE3540C->date_add = date('Y-m-d H:i:s');    $R1FECDBE9D501D58782B557793BE3540C->date_upd = $R1FECDBE9D501D58782B557793BE3540C->date_add ;    $R1FECDBE9D501D58782B557793BE3540C->amount = Tools::ps_round($this->context->cart->getOrderTotal(true, Cart::BOTH) * $R70EBC679B0540EF4F29FBA398C611CB8,2);    if($R1FECDBE9D501D58782B557793BE3540C->amount<=0)    {     $R0EB1982D9BAA9716AC37A8F047D5800D[] = $this->getL('Payment amount error:' . $R1FECDBE9D501D58782B557793BE3540C->amount);             return $R0EB1982D9BAA9716AC37A8F047D5800D;    }          $R9E9DB3BD4CF79145A46324858A119AAA = array();      $R5B92E56774920499F4ADDD0EC782C83E = 0;    $R7508B0AA1C07D8143C4A25F8FBDDD242 = count($R66728EA03984F2F03C3BF2A2B650973F);    $R0BCF672444581AF33549415BA10C3787 = intval(Configuration::get('AGILE_PAYPALAD_PAYSTYLE'));    foreach($R66728EA03984F2F03C3BF2A2B650973F AS $R95909C49377A2B4F24C79D29C629AF65 =>  $R52FC1BA91D10F611E03D61C01C5F72EB)    {        $R68EAF33C4E51B47C7219F805B449C109 = Tools::ps_round($R52FC1BA91D10F611E03D61C01C5F72EB['amount'] * $R70EBC679B0540EF4F29FBA398C611CB8,2);     if($R68EAF33C4E51B47C7219F805B449C109 <=0)continue;        $R58143D9578E0CEA90F1A9CC72E9B80CF = 0;     if($R52FC1BA91D10F611E03D61C01C5F72EB['email'] == $R0CD215FF6A25E893125B761431830E1F AND $R7508B0AA1C07D8143C4A25F8FBDDD242>1 AND $R0BCF672444581AF33549415BA10C3787 == AgilePaypalAdaptive::ADAPTIVE_STYLE_CHAINED)$R58143D9578E0CEA90F1A9CC72E9B80CF = 1;     $R5833E3A8A6369DC080AEC0C5C218A954[Pay::$receiverEmail[$R5B92E56774920499F4ADDD0EC782C83E]] = $R52FC1BA91D10F611E03D61C01C5F72EB['email'];     $R5833E3A8A6369DC080AEC0C5C218A954[Pay::$receiverAmount[$R5B92E56774920499F4ADDD0EC782C83E]] = Tools::ps_round($R52FC1BA91D10F611E03D61C01C5F72EB['amount'] * $R70EBC679B0540EF4F29FBA398C611CB8,2);     $R5833E3A8A6369DC080AEC0C5C218A954[Pay::$primaryReceiver[$R5B92E56774920499F4ADDD0EC782C83E]] = $R58143D9578E0CEA90F1A9CC72E9B80CF;     $RDADBDE6DA00922BBCB7461BF44AC8F34 = AgilePaypalAdaptiveTxnDetail::getTxnDetailIDByCartSellerId($this->context->cart->id,$R95909C49377A2B4F24C79D29C629AF65);     $R0A6D814D2B0D7584B066ED474359EB6A = new AgilePaypalAdaptiveTxnDetail($RDADBDE6DA00922BBCB7461BF44AC8F34);     $R0A6D814D2B0D7584B066ED474359EB6A->id_seller = $R95909C49377A2B4F24C79D29C629AF65;     $R0A6D814D2B0D7584B066ED474359EB6A->id_cart = $this->context->cart->id;     $R0A6D814D2B0D7584B066ED474359EB6A->id_currency = $RF9F42DF316FBD92CB7F35D539398F40A->id;     $R0A6D814D2B0D7584B066ED474359EB6A->receiver_email = $R52FC1BA91D10F611E03D61C01C5F72EB['email'];     $R0A6D814D2B0D7584B066ED474359EB6A->is_primary = $R58143D9578E0CEA90F1A9CC72E9B80CF;     $R0A6D814D2B0D7584B066ED474359EB6A->amount = $R5833E3A8A6369DC080AEC0C5C218A954[Pay::$receiverAmount[$R5B92E56774920499F4ADDD0EC782C83E]];        $R0A6D814D2B0D7584B066ED474359EB6A->status = 'INIT';   $R0A6D814D2B0D7584B066ED474359EB6A->date_add = date('Y-m-d H:i:s');     $R0A6D814D2B0D7584B066ED474359EB6A->date_upd = $R0A6D814D2B0D7584B066ED474359EB6A->date_add;                 if($R58143D9578E0CEA90F1A9CC72E9B80CF)      $R0A6D814D2B0D7584B066ED474359EB6A->record_type = AgilePaypalAdaptiveTxnDetail::RECORD_TYPE_BUYER_PAY_STORE;     else      $R0A6D814D2B0D7584B066ED474359EB6A->record_type = AgilePaypalAdaptiveTxnDetail::RECORD_TYPE_STORE_PAY_SELLER;     $R0A6D814D2B0D7584B066ED474359EB6A->paykey = '';       $R9E9DB3BD4CF79145A46324858A119AAA[] = $R0A6D814D2B0D7584B066ED474359EB6A;               $R5B92E56774920499F4ADDD0EC782C83E++;    }          if($R1FECDBE9D501D58782B557793BE3540C->amount<=0)    {     $R0EB1982D9BAA9716AC37A8F047D5800D[] = $this->getL('Payment amount error:' . $R1FECDBE9D501D58782B557793BE3540C->amount);             return $R0EB1982D9BAA9716AC37A8F047D5800D;    }          if($preapprovalKey!= "")    {     $R5833E3A8A6369DC080AEC0C5C218A954[Pay::$preapprovalKey] = $preapprovalKey;    }    if($senderEmail!= "")    {     $R5833E3A8A6369DC080AEC0C5C218A954[Pay::$senderEmail]  = $senderEmail;    }      $R4C29DCF7F80714F8250D9D915B6B4D7D=http_build_query($R5833E3A8A6369DC080AEC0C5C218A954, '', '&');     $R37568C010576B6181AE26BA9B1D67557 = 0;    $R780D616D28BCD1DE76F651A0525C5EF4 = '';        if(isset($_SESSION['curl_call_error']))unset($_SESSION['curl_call_error']);    $R9FCE541BFAFF6D24E7FCB051994D230F=hash_call($this->getPaypalServiceEndpoint(),'AdaptivePayments/Pay',$R4C29DCF7F80714F8250D9D915B6B4D7D);    if(isset($_SESSION['curl_call_error']))    {     $R0EB1982D9BAA9716AC37A8F047D5800D[] = $_SESSION['curl_call_error'];     return $R0EB1982D9BAA9716AC37A8F047D5800D;    }         $RE9B5F92229DC3A6BEFB8ADA452842EC1 = strtoupper($R9FCE541BFAFF6D24E7FCB051994D230F['responseEnvelope.ack']);     if($RE9B5F92229DC3A6BEFB8ADA452842EC1!="SUCCESS")    {     foreach($R9FCE541BFAFF6D24E7FCB051994D230F as $RF413F06AEBBCEF5E1C8B1019DEE6FE6B => $R7D0596C36891967F3BB9D994B4A97C19)      {      $R0EB1982D9BAA9716AC37A8F047D5800D[] =  "$RF413F06AEBBCEF5E1C8B1019DEE6FE6B: $R7D0596C36891967F3BB9D994B4A97C19<br />";     }      return $R0EB1982D9BAA9716AC37A8F047D5800D;    }          $paykey =$R9FCE541BFAFF6D24E7FCB051994D230F['payKey'];    if($R9FCE541BFAFF6D24E7FCB051994D230F['paymentExecStatus'] != "CREATED" )    {     $R0EB1982D9BAA9716AC37A8F047D5800D[] = $this->getL('Unknown result');     return $R0EB1982D9BAA9716AC37A8F047D5800D;    }    $R1FECDBE9D501D58782B557793BE3540C->paykey = $paykey;    $R1FECDBE9D501D58782B557793BE3540C->save();      for($R5B92E56774920499F4ADDD0EC782C83E=0;$R5B92E56774920499F4ADDD0EC782C83E<count($R9E9DB3BD4CF79145A46324858A119AAA);$R5B92E56774920499F4ADDD0EC782C83E++)    {     $R9E9DB3BD4CF79145A46324858A119AAA[$R5B92E56774920499F4ADDD0EC782C83E]->paykey = $paykey;     $R9E9DB3BD4CF79145A46324858A119AAA[$R5B92E56774920499F4ADDD0EC782C83E]->save();    }    return $R0EB1982D9BAA9716AC37A8F047D5800D;       }     public function hookActionAgilePaymentModuleIntegrate($RC2D2567438B1F39DD71F78195B5F3DED)   {    return array(     'name' => $this->name,     'desc' => $this->displayName,     'mode' => self::$PaymentCollectionMode,     'info1' => array('label' => $this->l('Paypal Email Address'), 'is_unique'=>0),     'info2' => array('label' => 'N/A','is_unique'=>0),     'info3' => array('label' => 'N/A','is_unique'=>0),     'info4' => array('label' => 'N/A','is_unique'=>0),     'info5' => array('label' => 'N/A','is_unique'=>0),     'info6' => array('label' => 'N/A','is_unique'=>0),     'info7' => array('label' => 'N/A','is_unique'=>0),     'info8' => array('label' => 'N/A','is_unique'=>0),     );   }      private function replaceEmailAddress($R66728EA03984F2F03C3BF2A2B650973F)   {      foreach($R66728EA03984F2F03C3BF2A2B650973F as $R95909C49377A2B4F24C79D29C629AF65 => $RB60574D852CEEC26638BCD30B5ED74D6)    {     if($R95909C49377A2B4F24C79D29C629AF65 ==0)$RB60574D852CEEC26638BCD30B5ED74D6['email'] = Configuration::get('AGILE_PAYPALAD_BUSINESS');     else      {      include_once(_PS_ROOT_DIR_  . "/modules/agilemultipleseller/AgileSellerPaymentInfo.php");     $R602BAA072843820A45861C75C510C77E = AgileSellerPaymentInfo::getForSellerByModuleName($this->name, $R95909C49377A2B4F24C79D29C629AF65);     $RB60574D852CEEC26638BCD30B5ED74D6['email'] = $R602BAA072843820A45861C75C510C77E->info1;    }     $R66728EA03984F2F03C3BF2A2B650973F[$R95909C49377A2B4F24C79D29C629AF65] = $RB60574D852CEEC26638BCD30B5ED74D6;    }    return $R66728EA03984F2F03C3BF2A2B650973F;   }  }  