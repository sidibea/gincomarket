<?php
$GLOBALS["okAfyBhLHLVYumxfsuzs"]=base64_decode("Vm91Y2hlciBuYW1lIGludmFsaWQu");$GLOBALS["lRBzvzBSEQkJxdBItbg"]=base64_decode("LA==");$GLOBALS["KnVlobcxtuAmswIXxCgS"]=base64_decode("aWRfYWRkcmVzc19kZWxpdmVyeQ==");$GLOBALS["AknMeFLMlEzOuWbOoPcG"]=base64_decode("aWRfYWRkcmVzc19pbnZvaWNl");$GLOBALS["clDBUEZYNUFAaVDeeJcN"]=base64_decode("U2hvcHBpbmdDYXJ0");$GLOBALS["CSKMNIqVzaBoQStRpqGK"]=base64_decode("ZGVsYXk=");$GLOBALS["dLjYwJEMKEadGctIXhMQ"]=base64_decode("aW5zdHJ1Y3Rpb25z");$GLOBALS["asxETQgoYgCVOHXhnboY"]=base64_decode("Y3VycmVuY3k=");$GLOBALS["GCGFbJCidDfsPuCoAHNX"]=base64_decode("cHJpY2VfdGF4X2V4Yw==");$GLOBALS["IXCfKzsjlitrRiMXFvE"]=base64_decode("cHJpY2U=");$GLOBALS["cZkwkPLDyMymURQTbgjs"]=base64_decode("bG9nbw==");$GLOBALS["FKJJSrcKfNlcouSwAAmL"]=base64_decode("dGl0bGU=");$GLOBALS["NVfQfcfEMlbuxzbpTZKL"]=base64_decode("c21faWQ=");$GLOBALS["jbXphvSsacaLLzGPgymI"]=base64_decode("L21vZHVsZXMvb25lcGFnZWNoZWNrb3V0cHMvdmlld3MvaW1nL3NoaXBwaW5nLnBuZw==");$GLOBALS["CcDwQtiWeMeNVIOEQlbB"]=base64_decode("b25lcGFnZWNoZWNrb3V0cHM=");$GLOBALS["TzkLUMytHhQrOhoLOkjl"]=base64_decode("aW1n");$GLOBALS["BoWuBfavKqJxeLgCuLA"]=base64_decode("bmFtZQ==");$GLOBALS["ceWvPMTYsHXEqOwfEzYm"]=base64_decode("UFNfQ0FSUklFUl9ERUZBVUxU");$GLOBALS["yXWULPqOlNKxZKywHyyg"]=base64_decode("aWRfY2Fycmllcg==");$GLOBALS["iQluyDVETbtdbtoNFHYC"]=base64_decode("ZnJlZQ==");$GLOBALS["tugkmwKQmrdyfghQnRJj"]=base64_decode("");$GLOBALS["FhzXsRsmAttmXNINpnhh"]=base64_decode("Zmlyc3RuYW1l");$GLOBALS["GNgmbRbejfRAIZpcZGBR"]=base64_decode("Y291bnRyeV9pZA==");$GLOBALS["SJMQQHzjLEdLVmUkMEza"]=base64_decode("VXNlcg==");$GLOBALS["IllxivRAsHwmadZmnjPz"]=base64_decode("Y291cG9uX2NvZGU=");$GLOBALS["EATCzQlwIticdwizFpuU"]=base64_decode("c2hpcHBpbmdfbWV0aG9kcw==");$GLOBALS["uVuEDCLjTSQjNtEpPTGN"]=base64_decode("aXRlbXM=");$GLOBALS["oDmPhbNfhHIpQyZfv"]=base64_decode("dW5hbWU=");$GLOBALS["VJrqUxlwESnFpVzufJds"]=base64_decode("bWVzc2FnZXM=");$GLOBALS["yKpOJJNRCGgFPvXUOLGg"]=base64_decode("aXNfdmlydHVhbA==");$GLOBALS["VdVzZmgPZuXwDwiTrzI"]=base64_decode("cHJpY2VfaW5mb3M=");$GLOBALS["WSufSOAPQLmPOhPsflsc"]=base64_decode("YmlsbGluZ19hZGRyZXNzX3ZhbGlk");$GLOBALS["RdGyvTBKcLIXRJhYClZs"]=base64_decode("c2VsZWN0ZWRfc2hpcHBpbmdfbWV0aG9kX2lk");$GLOBALS["UElPVbRMEAhfLkwlLBYg"]=base64_decode("bmVlZF9zZWxlY3Rfc2hpcHBpbmdfbWV0aG9k");$GLOBALS["zaKVVthEzHZzmtgcUlfJ"]=base64_decode("U3RvcmU=");$GLOBALS["WQkxuEYvIGleLlQpxRTS"]=base64_decode("bmVlZF9zaGlwcGluZ19hZGRyZXNz");$GLOBALS["zqwCOZbNlAGugOKLmuJg"]=base64_decode("TkVFRF9CSUxMSU5HX0FERFJFU1M=");$GLOBALS["KMHUeGxTLavIzmKdWuDm"]=base64_decode("bmVlZF9iaWxsaW5nX2FkZHJlc3M=");$GLOBALS["ximeOHNodYpCldodXWPb"]=base64_decode("cmV2aWV3X29yZGVycw==");$GLOBALS["IioRvFMpbjxLVvTrXse"]=base64_decode("YmlsbGluZ19hZGRyZXNz");$GLOBALS["rUVLMDNCwQuomgyFgSRa"]=base64_decode("c2hpcHBpbmdfYWRkcmVzcw==");$GLOBALS["vnikmTnwHXDcKJBQNHoK"]=base64_decode("TW9iaWNvbW1lcmNlaGVscGVy");$GLOBALS["IUwAYmcExpFZNhTTNAPU"]=base64_decode("YmxvY2tjYXJ0");$GLOBALS["PdepTkCacGhHbSYynMub"]=base64_decode("SFRUUC8xLjEgNDA0IE5vdCBGb3VuZA==");$GLOBALS["QIfjBqYCYzCTbgddRxFH"]=base64_decode("SU5fTU9CSUNPTU1FUkNF");
?><?php


if (!defined($GLOBALS["QIfjBqYCYzCTbgddRxFH"]))
{
    header($GLOBALS["PdepTkCacGhHbSYynMub"]);
    die();
}

class CheckoutService extends BaseService
{
    private $errors = array();
    private $isFreeShipping = false;
    private $isVirtual = false;
    private $_cart = null;
    public $mod = 'blockcart';

    public function __construct()
    {
        parent::__construct();
        ServiceFactory::factory($GLOBALS["vnikmTnwHXDcKJBQNHoK"])->autoLoginMobileUser();
    }

    public function detail()
    {
        $detail = array();
        $detail['shipping_address'] = $this->getShippingAddress();
        $detail['billing_address'] = $this->getBillingAddress();
        $detail['review_orders'] = array($this->getReviewOrder());
        $detail[$GLOBALS["KMHUeGxTLavIzmKdWuDm"]] = defined($GLOBALS["zqwCOZbNlAGugOKLmuJg"]) ? NEED_BILLING_ADDRESS : FALSE;
        $detail[$GLOBALS["WQkxuEYvIGleLlQpxRTS"]] = !ServiceFactory::factory($GLOBALS["zaKVVthEzHZzmtgcUlfJ"])->checkAddressIntegrity($detail[$GLOBALS["rUVLMDNCwQuomgyFgSRa"]]);
        $detail[$GLOBALS["UElPVbRMEAhfLkwlLBYg"]] = (!$this->isVirtual && !$detail[$GLOBALS["ximeOHNodYpCldodXWPb"]][0][$GLOBALS["RdGyvTBKcLIXRJhYClZs"]]);
        $detail[$GLOBALS["WSufSOAPQLmPOhPsflsc"]] = ServiceFactory::factory($GLOBALS["zaKVVthEzHZzmtgcUlfJ"])->checkAddressIntegrity($detail[$GLOBALS["IioRvFMpbjxLVvTrXse"]]);

        $detail[$GLOBALS["VdVzZmgPZuXwDwiTrzI"]] = $this->getCart()->getPriceInfo();
        $detail[$GLOBALS["yKpOJJNRCGgFPvXUOLGg"]] = $this->context->cart->isVirtualCart();
        $detail[$GLOBALS["VJrqUxlwESnFpVzufJds"]] = $this->errors;
        if (isset($this->context->cookie->guest_uname))
        {
            $detail[$GLOBALS["oDmPhbNfhHIpQyZfv"]] = $this->context->cookie->guest_uname;
            unset($this->context->cookie->guest_uname);
        }
        return $detail;
    }

    public function getReviewOrder()
    {
        $order = array();
        $carriers = array();
        $order['items'] = $this->getCart()->getProducts();
        $order['shipping_methods'] = $this->getOrderShippingMethods($carriers);
        $order[$GLOBALS["RdGyvTBKcLIXRJhYClZs"]] = $this->selectShippingMethod($carriers);
        $this->context->cookie->coupon && $order[$GLOBALS["IllxivRAsHwmadZmnjPz"]] = $this->context->cookie->coupon;

        return $order;
    }

    private function getSendToAddressId()
    {
        if (!$this->context->cart->id_address_delivery)
        {
            $this->context->cart->id_address_delivery = Address::getFirstCustomerAddressId($this->context->cookie->id_customer);
        }

        return $this->context->cart->id_address_delivery;
    }

    public function getShippingAddress()
    {
        $sendTo = $this->getSendToAddressId();
        if ($sendTo)
        {
            $addr = ServiceFactory::factory($GLOBALS["SJMQQHzjLEdLVmUkMEza"])->getAddress($sendTo);
            $country = new Country($addr[$GLOBALS["GNgmbRbejfRAIZpcZGBR"]]);
            $addr[$GLOBALS["GNgmbRbejfRAIZpcZGBR"]] = $country->iso2;
            return $addr;
        }
        return array();
    }

    public function getBillingAddress()
    {
        $billto = $this->getBillToAddressId();
        if ($billto)
        {
            $addr = ServiceFactory::factory($GLOBALS["SJMQQHzjLEdLVmUkMEza"])->getAddress($billto);
            $country = new Country($addr[$GLOBALS["GNgmbRbejfRAIZpcZGBR"]]);
            $addr[$GLOBALS["GNgmbRbejfRAIZpcZGBR"]] = $country->iso2;
            return $addr;
        }
        else
        {
            return array('firstname' => '');
        }
        return array();
    }

    public function getBillToAddressId()
    {
        if (!$this->context->cart->id_address_invoice)
        {
            $this->context->cart->id_address_invoice = Address::getFirstCustomerAddressId($this->context->cookie->id_customer);
        }

        return $this->context->cart->id_address_invoice;
    }

    public function selectShippingMethod($carriers)
    {
        if ($this->isFreeShipping || $this->isVirtual)
        {
            $this->context->cart->id_carrier = false;
        }
        else
        {
            $this->context->cart->id_carrier = $this->getDefaultCarrierSelection($carriers, $this->context->cart->id_carrier);
        }
        $this->context->cart->update();
        $this->context->cookie->id_carrier = $this->context->cart->id_carrier;
        return $this->context->cart->id_carrier ? $this->context->cart->id_carrier : $GLOBALS["iQluyDVETbtdbtoNFHYC"];
    }

    
    public function getDefaultCarrierSelection($carriers, $default_carrier = 0)
    {
        if (empty($carriers))
        {
            return 0;
        }

        if ((int) $default_carrier != 0)
        {
            foreach ($carriers as $carrier)
            {
                if ($carrier[$GLOBALS["yXWULPqOlNKxZKywHyyg"]] == (int) $default_carrier)
                {
                    return (int) $carrier[$GLOBALS["yXWULPqOlNKxZKywHyyg"]];
                }
            }
        }

        foreach ($carriers as $carrier)
        {
            if ($carrier[$GLOBALS["yXWULPqOlNKxZKywHyyg"]] == (int) Configuration::get($GLOBALS["ceWvPMTYsHXEqOwfEzYm"]))
            {
                return (int) $carrier[$GLOBALS["yXWULPqOlNKxZKywHyyg"]];
            }
        }

        return (int) $carriers[0][$GLOBALS["yXWULPqOlNKxZKywHyyg"]];
    }

    public function getOrderShippingMethods(&$carriers)
    {
        if ($this->context->cart->isVirtualCart())
        {
                        $this->isVirtual = true;
            return array();
        }
        else if ($this->context->cart->getOrderTotal(true, ONLY_SHIPPING) == 0)
        {
                        
        }

        $availableShippingMethods = array();
        if ($this->context->cart->id_address_delivery)
        {
            $deliveryAddress = new Address($this->context->cart->id_address_delivery);
        }
        if ($this->context->cookie->id_customer)
        {
            $customer = new Customer((int) ($this->context->cookie->id_customer));
            $groups = $customer->getGroups();
        }
        else
        {
            $groups = array(1);
        }

        
        {
            

            

            $carriers = $this->context->cart->simulateCarriersOutput(null, true);
            foreach($carriers as &$_carrier)
            {
                $_carrier[$GLOBALS["yXWULPqOlNKxZKywHyyg"]] = Cart::desintifier($_carrier[$GLOBALS["yXWULPqOlNKxZKywHyyg"]], $GLOBALS["tugkmwKQmrdyfghQnRJj"]);
            }
        }
        
                
        
        foreach ($carriers as $carrier)
        {
            
            $title = $carrier[$GLOBALS["BoWuBfavKqJxeLgCuLA"]];
            $logo = null;
            if(isset($carrier[$GLOBALS["TzkLUMytHhQrOhoLOkjl"]]) && $carrier[$GLOBALS["TzkLUMytHhQrOhoLOkjl"]] && file_exists(_PS_ROOT_DIR_ . $carrier[$GLOBALS["TzkLUMytHhQrOhoLOkjl"]]))
            {
                $logo = Tools::getHttpHost(true) . $carrier[$GLOBALS["TzkLUMytHhQrOhoLOkjl"]];
            }
            else if (Module::isInstalled($GLOBALS["CcDwQtiWeMeNVIOEQlbB"]) && Module::isEnabled($GLOBALS["CcDwQtiWeMeNVIOEQlbB"]))
            {
                $logo = Tools::getHttpHost(true) . $GLOBALS["jbXphvSsacaLLzGPgymI"];
            }

                        
            
            $_method = array();
            $_method['sm_id'] = $carrier['id_carrier'];
            $_method['title'] = $title;
            $_method['logo']  = $logo;
            $_method['price'] = $carrier['price'];
            $_method['price_tax_exc'] = $carrier['price'];
            if(isset($carrier['price_tax_exc'])){
                $_method[$GLOBALS["GCGFbJCidDfsPuCoAHNX"]] = $carrier[$GLOBALS["GCGFbJCidDfsPuCoAHNX"]];
            }
            $_method[$GLOBALS["asxETQgoYgCVOHXhnboY"]] = $this->context->cookie->currency;
            $_method[$GLOBALS["dLjYwJEMKEadGctIXhMQ"]] = $carrier[$GLOBALS["CSKMNIqVzaBoQStRpqGK"]];
            

            $availableShippingMethods[] = $_method;
        }

        return $availableShippingMethods;
    }

    private function getCart()
    {
        if (is_null($this->_cart))
        {
            $this->_cart = ServiceFactory::factory($GLOBALS["clDBUEZYNUFAaVDeeJcN"]);
        }

        return $this->_cart;
    }

    public function addAddress($address)
    {
        if ($this->context->cookie->isLogged())
        {
            $result = ServiceFactory::factory($GLOBALS["SJMQQHzjLEdLVmUkMEza"])->addAddress($address);

            if (is_numeric($result))
            {
                                $this->context->cart->id_address_delivery = $result;
                $this->context->cart->id_address_invoice = $result;
            }

            return $result;
        }
    }

    public function updateAddress($address)
    {
        if ($this->context->cookie->isLogged())
        {
            if ($address)
            {
                $this->context->cart->id_address_invoice = $address[$GLOBALS["AknMeFLMlEzOuWbOoPcG"]];
                $this->context->cart->id_address_delivery = $address[$GLOBALS["KnVlobcxtuAmswIXxCgS"]];

                CartRule::autoRemoveFromCart($this->context);
                CartRule::autoAddToCart($this->context);

                $this->context->cart->update();

                $this->context->cart->id_address_invoice = $address[$GLOBALS["AknMeFLMlEzOuWbOoPcG"]];
                $this->context->cart->id_address_delivery = $address[$GLOBALS["KnVlobcxtuAmswIXxCgS"]];
                $this->context->cart->update();
            }
        }
    }

    public function updateShippingMethod($shippingMethod)
    {
        if (is_numeric($shippingMethod) && $shippingMethod > 0)
        {
            $this->context->cart->id_carrier = (int)$shippingMethod;  
            
            $this->context->cart->setDeliveryOption(array($this->context->cart->id_address_delivery => $GLOBALS["tugkmwKQmrdyfghQnRJj"].$shippingMethod.$GLOBALS["lRBzvzBSEQkJxdBItbg"]));
            

            $this->context->cookie->id_carrier = $this->context->cart->id_carrier;           }
    }

    public function updateCoupon($couponCode)
    {
        if (empty($couponCode))
        {
            if (Validate::isUnsignedId($this->context->cookie->id_coupon))
            {
                $this->context->cart->deleteDiscount($this->context->cookie->id_coupon);
                unset($this->context->cookie->coupon);
                unset($this->context->cookie->id_coupon);
            }
        }
        else
        {
            $errors = array();
            if (!Validate::isDiscountName($couponCode))
            {
                $errors[] = Tools::displayError($GLOBALS["okAfyBhLHLVYumxfsuzs"]);
            }
            else
            {
                $discount = new Discount((int) (Discount::getIdByName($couponCode)));
                if (Validate::isLoadedObject($discount))
                {
                    if (($tmpError = $this->context->cart->checkDiscountValidity($discount, $this->context->cart->getDiscounts(), $this->context->cart->getOrderTotal(), $this->context->cart->getProducts(), true)))
                        $errors[] = $tmpError;
                }
                else
                {
                    $errors[] = Tools::displayError($GLOBALS["okAfyBhLHLVYumxfsuzs"]);
                }

                if (!sizeof($errors))
                {
                    $this->context->cart->addDiscount((int) ($discount->id));
                    $this->context->cookie->coupon = $couponCode;
                    $this->context->cookie->id_coupon = $discount->id;
                    $this->context->cart->getDiscounts(false, true);                 }
            }
        }

        
        if ($this->context->cart->isVirtualCart())
        {
            $this->context->cart->id_carrier = 0;
            $this->context->cart->update();
        }

        return $errors;
    }
}
 ?>