<?php
$GLOBALS["aqniIhJmuVXsbzgsVTIk"]=base64_decode("IE9SREVSIEJZIGYuaWRfbG95YWx0eSBERVNDIExJTUlUIDAsMQ==");$GLOBALS["hHLbnTnXUKfNJPlZjpJR"]=base64_decode("DQogICAgICAgIEFORCBmLmBpZF9jYXJ0X3J1bGVgID4gMA0KICAgICAgICBBTkQgby5gdmFsaWRgID0gMQ0KICAgICAgICBBTkQgcXVhbnRpdHkgPiAwDQogICAgICAgIEdST1VQIEJZIGYuaWRfY2FydF9ydWxl");$GLOBALS["rmTRwwNJgQwuPlPrmNxa"]=base64_decode("Y2FydF9ydWxlYCBjciBPTiAoY3IuYGlkX2NhcnRfcnVsZWAgPSBmLmBpZF9jYXJ0X3J1bGVgKQ0KICAgICAgICBXSEVSRSBmLmBpZF9jdXN0b21lcmAgPSA=");$GLOBALS["ISAzfFWDcwXSvfkoIAg"]=base64_decode("b3JkZXJzYCBvIE9OIChmLmBpZF9vcmRlcmAgPSBvLmBpZF9vcmRlcmApDQogICAgICAgIElOTkVSIEpPSU4gYA==");$GLOBALS["OyBKShmLfeObrVAVvcIw"]=base64_decode("bG95YWx0eWAgZg0KICAgICAgICBMRUZUIEpPSU4gYA==");$GLOBALS["ZVBjkLfBVVJTzuiCfoNb"]=base64_decode("DQogICAgICAgIFNFTEVDVCBmLmlkX2NhcnRfcnVsZSBBUyBpZF9jYXJ0X3J1bGUsIGYuZGF0ZV91cGQgQVMgZGF0ZV9hZGQNCiAgICAgICAgRlJPTSBg");$GLOBALS["UErXESVgiXETbMaUsAvm"]=base64_decode("LCA=");$GLOBALS["BoWuBfavKqJxeLgCuLA"]=base64_decode("bmFtZQ==");$GLOBALS["QVWFuLyKVyGmMRnfrqPG"]=base64_decode("aWRfY2F0ZWdvcnk=");$GLOBALS["lRBzvzBSEQkJxdBItbg"]=base64_decode("LA==");$GLOBALS["tugkmwKQmrdyfghQnRJj"]=base64_decode("");$GLOBALS["YBfRzBIoZpTEkcFcKNgP"]=base64_decode("UFNfTE9ZQUxUWV9WT1VDSEVSX0NBVEVHT1JZ");$GLOBALS["QeLnMPpvndUVxKAOxlRH"]=base64_decode("bWluaW11bV90ZXh0");$GLOBALS["FKJJSrcKfNlcouSwAAmL"]=base64_decode("dGl0bGU=");$GLOBALS["ZwyXGFVAaJkvyAKUbcok"]=base64_decode("dG90YWxfcG9pbnRzX3RleHQ=");$GLOBALS["jOcDrWNJePfvcnTOnujE"]=base64_decode("dG90YWxfcG9pbnRz");$GLOBALS["kRcLrhZXuXDpcYuzpmwx"]=base64_decode("dHJhbnNmb3JtYXRpb25fdGV4dA==");$GLOBALS["stPsEmZdhkBDWNBfXZtQ"]=base64_decode("Y2F0ZWdvcnlfdGV4dA==");$GLOBALS["TOeAMkZYbiIeTLssrRUI"]=base64_decode("Y291bnQ=");$GLOBALS["xdqLbjMkqNwAldSnYJvs"]=base64_decode("bGlzdA==");$GLOBALS["iKLyShFQlpjmJpFfaoec"]=base64_decode("IA==");$GLOBALS["jmyCGszUIpGoCyjUqpfn"]=base64_decode("UFNfTE9ZQUxUWV9NSU5JTUFM");$GLOBALS["jvNUZuArDlDbVsDKKNjT"]=base64_decode("c3RhdHVz");$GLOBALS["KEIaVoEwhIoBCMBsuRaf"]=base64_decode("cXVhbnRpdHk=");$GLOBALS["NQyMjpmtARzsdHodcqGo"]=base64_decode("ZGF0ZV90bw==");$GLOBALS["MliOZSzhfzWLfGFNVamX"]=base64_decode("ZGF0ZV9mcm9t");$GLOBALS["NeEpoqFHXrKePHrDMboS"]=base64_decode("WS1tLWQ=");$GLOBALS["iIOFUMrwXnyUpFNxRMjx"]=base64_decode("ZGF0ZV9hZGQ=");$GLOBALS["bJVDJcBfjwWDhPgYNynR"]=base64_decode("aWRfY2FydF9ydWxl");$GLOBALS["aQuZLtAcKEnDNSgCrOUx"]=base64_decode("bW9kdHBs");$GLOBALS["aRbFXpGNJoCqQsoKJrhE"]=base64_decode("bG95YWx0eQ==");$GLOBALS["eiMjHdOTkxJOAwMCNHkD"]=base64_decode("bW9k");$GLOBALS["ulKHpLyTKLxVrBIkXkKp"]=base64_decode("L21vZHVsZXMvbG95YWx0eS9Mb3lhbHR5U3RhdGVNb2R1bGUucGhw");$GLOBALS["ObLueeKbATghxYWafgAQ"]=base64_decode("L21vZHVsZXMvbG95YWx0eS9Mb3lhbHR5TW9kdWxlLnBocA==");$GLOBALS["vnikmTnwHXDcKJBQNHoK"]=base64_decode("TW9iaWNvbW1lcmNlaGVscGVy");$GLOBALS["PdepTkCacGhHbSYynMub"]=base64_decode("SFRUUC8xLjEgNDA0IE5vdCBGb3VuZA==");$GLOBALS["QIfjBqYCYzCTbgddRxFH"]=base64_decode("SU5fTU9CSUNPTU1FUkNF");$GLOBALS["mphyAqbsfiBMTKVjJQ"]=base64_decode("QWxs");$GLOBALS["YupmFrjNcEptorPoHgZG"]=base64_decode("Vm91Y2hlcnMgZ2VuZXJhdGVkIGhlcmUgYXJlIHVzYWJsZSBpbiB0aGUgZm9sbG93aW5nIGNhdGVnb3JpZXMgOiA=");$GLOBALS["sJyPgbnkJXUqYWdheEqE"]=base64_decode("VGhlIG1pbmltdW0gb3JkZXIgYW1vdW50IGluIG9yZGVyIHRvIHVzZSB0aGVzZSB2b3VjaGVycyBpczo=");$GLOBALS["nwrUrIJAfABiFCnyASQR"]=base64_decode("TXkgdm91Y2hlcnMgZnJvbSBsb3lhbHR5IHBvaW50cw==");$GLOBALS["SRpVdUaZhuNTHYmDlxFD"]=base64_decode("UmVhZHkgdG8gdXNl");$GLOBALS["vIEKrFsdoDxwHWsMoubT"]=base64_decode("WW91ciB0b3RhbCBwb2ludHMgYXZhaWxhYmxlIHRvIGJlIHVzZWQ6");$GLOBALS["ZUKrugOOGNsUDYpyIlzG"]=base64_decode("IA==");$GLOBALS["uzoJXPpNMkAPmuxPHPGD"]=base64_decode("VHJhbnNmb3JtIG15IHBvaW50cyBpbnRvIGEgdm91Y2hlciBvZg==");$GLOBALS["SnsSSwMKZSYeMFnEirnh"]=base64_decode("");
?><?php


if (!defined($GLOBALS["QIfjBqYCYzCTbgddRxFH"])) {
    header($GLOBALS["PdepTkCacGhHbSYynMub"]);
    die();
}


class LoyaltyService extends BaseService
{
    private $errors = array();
    private $context;

    public function __construct()
    {
        parent::__construct();
        ServiceFactory::factory($GLOBALS["vnikmTnwHXDcKJBQNHoK"])->autoLoginMobileUser();

        $this->context = Context::getContext();

        include_once(_PS_ROOT_DIR_.$GLOBALS["ObLueeKbATghxYWafgAQ"]);
        include_once(_PS_ROOT_DIR_.$GLOBALS["ulKHpLyTKLxVrBIkXkKp"]);
    }

    public function getLoyaltyPoints($p = 0, $n = 0)
    {
        $displayorders = LoyaltyModule::getAllByIdCustomer(
            (int)$this->context->customer->id,
            (int)$this->context->language->id, false, true,
            $n,
            $p
        );

        $count = LoyaltyModule::getAllByIdCustomer(
            (int)$this->context->customer->id,
            (int)$this->context->language->id, false, true,
            5000,
            $p
        );

        $customer_points = (int)LoyaltyModule::getPointsByCustomer((int)$this->context->customer->id);
        $transformation_allowed = $customer_points > 0;
        $transformation_text = $GLOBALS["SnsSSwMKZSYeMFnEirnh"];
        if($transformation_allowed){
            $transformation_text = $this->l($GLOBALS["uzoJXPpNMkAPmuxPHPGD"], array(
                'mod' => 'loyalty',
                'modtpl' => 'loyalty',
                ));
            $transformation_text .= $GLOBALS["ZUKrugOOGNsUDYpyIlzG"];
            $transformation_text .= LoyaltyModule::getVoucherValue($customer_points, (int)$this->context->currency->id);
        }
        $total_points_text = $this->l($GLOBALS["vIEKrFsdoDxwHWsMoubT"], array(
            'mod' => 'loyalty',
            'modtpl' => 'loyalty',
            ));

        $nb_discounts = 0;
        $discounts = array();
        
        if ($ids_discount = $this->getDiscountByIdCustomer((int)$this->context->customer->id))
        {
            $nb_discounts = count($ids_discount);
            foreach ($ids_discount as $key => $discount)
            {
                $discounts[$key] = new CartRule((int)$discount[$GLOBALS["bJVDJcBfjwWDhPgYNynR"]], (int)$this->context->cookie->id_lang);
                $discounts[$key]->orders = LoyaltyModule::getOrdersByIdDiscount((int)$discount[$GLOBALS["bJVDJcBfjwWDhPgYNynR"]]);
            }
        }

        if(!empty($discounts)){
            $final = array();
            foreach ($discounts as $key => $value) {
                $value = (array)$value;
                $value[$GLOBALS["iIOFUMrwXnyUpFNxRMjx"]] = date($GLOBALS["NeEpoqFHXrKePHrDMboS"], strtotime($value[$GLOBALS["iIOFUMrwXnyUpFNxRMjx"]]));
                $value[$GLOBALS["MliOZSzhfzWLfGFNVamX"]] = date($GLOBALS["NeEpoqFHXrKePHrDMboS"], strtotime($value[$GLOBALS["MliOZSzhfzWLfGFNVamX"]]));
                $value[$GLOBALS["NQyMjpmtARzsdHodcqGo"]] = date($GLOBALS["NeEpoqFHXrKePHrDMboS"], strtotime($value[$GLOBALS["NQyMjpmtARzsdHodcqGo"]]));
                $qty = $value[$GLOBALS["KEIaVoEwhIoBCMBsuRaf"]];
                
                    $value[$GLOBALS["jvNUZuArDlDbVsDKKNjT"]] = $this->l($GLOBALS["SRpVdUaZhuNTHYmDlxFD"], array(
                        'mod' => 'loyalty',
                        'modtpl' => 'loyalty',
                        ));
                
                
                $final[] = $value;
            }
            $discounts = $final;
        }

        $title = $this->l($GLOBALS["nwrUrIJAfABiFCnyASQR"], array(
            'mod' => 'loyalty',
            'modtpl' => 'loyalty',
            ));

        $minimum_text = $this->l($GLOBALS["sJyPgbnkJXUqYWdheEqE"], array(
                'mod' => 'loyalty',
                'modtpl' => 'loyalty',
                ));

        $minimalLoyalty = (float)Configuration::get($GLOBALS["jmyCGszUIpGoCyjUqpfn"]);
        $minimum_text = $minimum_text.$GLOBALS["iKLyShFQlpjmJpFfaoec"]. $minimalLoyalty;
        
        $result = array(
            
            'list'                => $discounts,
            'count'               => $nb_discounts,
            'category_text'       => $this->getCategoryText(),
            'transformation_text' => $transformation_text,
            'total_points'        => $customer_points,
            'total_points_text'   => $total_points_text,
            'title'               => $title,
            'minimum_text'        => $minimum_text
            );
        return $result;
        
    }

    public function getCategoryText()
    {
        $all_categories = Category::getSimpleCategories((int)$this->context->cookie->id_lang);
        $voucher_categories = Configuration::get($GLOBALS["YBfRzBIoZpTEkcFcKNgP"]);
        if ($voucher_categories != $GLOBALS["tugkmwKQmrdyfghQnRJj"] && $voucher_categories != 0)
            $voucher_categories = explode($GLOBALS["lRBzvzBSEQkJxdBItbg"], Configuration::get($GLOBALS["YBfRzBIoZpTEkcFcKNgP"]));
        else
            die(Tools::displayError());

        if (count($voucher_categories) == count($all_categories))
            $categories_names = null;
        else
        {
            $categories_names = array();
            foreach ($all_categories as $k => $all_category)
                if (in_array($all_category[$GLOBALS["QVWFuLyKVyGmMRnfrqPG"]], $voucher_categories))
                    $categories_names[$all_category[$GLOBALS["QVWFuLyKVyGmMRnfrqPG"]]] = trim($all_category[$GLOBALS["BoWuBfavKqJxeLgCuLA"]]);
            if (!empty($categories_names)){
                
                $categories_names = implode($GLOBALS["UErXESVgiXETbMaUsAvm"], $categories_names);
            }
            else
                $categories_names = null;
        }

        $text = $this->l($GLOBALS["YupmFrjNcEptorPoHgZG"], array(
            'mod' => 'loyalty',
            'modtpl' => 'loyalty',
            ));
        if($categories_names){
            $text .= $categories_names;
        }
        else{
            $text .= $this->l($GLOBALS["mphyAqbsfiBMTKVjJQ"], array(
                'mod' => 'loyalty',
                'modtpl' => 'loyalty',
                ));
        }
        return $text;
    }

    public function getDiscountByIdCustomer($id_customer, $last = false)
    {
        $query = $GLOBALS["ZVBjkLfBVVJTzuiCfoNb"]._DB_PREFIX_.$GLOBALS["OyBKShmLfeObrVAVvcIw"]._DB_PREFIX_.$GLOBALS["ISAzfFWDcwXSvfkoIAg"]._DB_PREFIX_.$GLOBALS["rmTRwwNJgQwuPlPrmNxa"].(int)($id_customer).$GLOBALS["hHLbnTnXUKfNJPlZjpJR"];
        if ($last)
            $query.= $GLOBALS["aqniIhJmuVXsbzgsVTIk"];

        return Db::getInstance()->executeS($query);
    }
}
 ?>