<?php
$GLOBALS["waWafEeALmeXuRDBxZD"]=base64_decode("aWRfbGFuZw==");$GLOBALS["feSiCyHZJEsqYvpXxAka"]=base64_decode("UFNfTEFOR19ERUZBVUxU");$GLOBALS["HFpPpqIwKxtqqkQFORvs"]=base64_decode("UFNfTE9ZQUxUWV9WT1VDSEVSX0RFVEFJTFM=");$GLOBALS["jmyCGszUIpGoCyjUqpfn"]=base64_decode("UFNfTE9ZQUxUWV9NSU5JTUFM");$GLOBALS["dlHOvghzOzgIapbTEaBm"]=base64_decode("ICsxIHllYXI=");$GLOBALS["WhhfbVVjffUiUYQXixVQ"]=base64_decode("WS1tLWQgSDppOnM=");$GLOBALS["CAGOFrnvdgvRWJOFcHBQ"]=base64_decode("UFNfT1JERVJfUkVUVVJOX05CX0RBWVM=");$GLOBALS["OhNAyUgOhHqvgQJDhxqx"]=base64_decode("UFNfT1JERVJfUkVUVVJO");$GLOBALS["niQwzeioWeGsKCNcKt"]=base64_decode("DQogICAgICAgICAgICBPUkRFUiBCWSBkYXRlX2FkZCBERVND");$GLOBALS["zXDVVUikoCFlqUnxPsMX"]=base64_decode("bG95YWx0eQ0KICAgICAgICAgICAgV0hFUkUgaWRfY2FydF9ydWxlID0gMCBBTkQgaWRfY3VzdG9tZXIgPSA=");$GLOBALS["EeoKhzjXRMpgceXmBUCz"]=base64_decode("DQogICAgICAgICAgICBTRUxFQ1QgVU5JWF9USU1FU1RBTVAoZGF0ZV9hZGQpIG4NCiAgICAgICAgICAgIEZST00g");$GLOBALS["qrenbSKokZGqIzIJUSaC"]=base64_decode("UFNfTE9ZQUxUWV9UQVg=");$GLOBALS["dinfSBXNSzPHmrudLI"]=base64_decode("RklE");$GLOBALS["hQMtQEXNnpjUEYrLmOsm"]=base64_decode("Lg==");$GLOBALS["UErXESVgiXETbMaUsAvm"]=base64_decode("LCA=");$GLOBALS["BoWuBfavKqJxeLgCuLA"]=base64_decode("bmFtZQ==");$GLOBALS["QVWFuLyKVyGmMRnfrqPG"]=base64_decode("aWRfY2F0ZWdvcnk=");$GLOBALS["lRBzvzBSEQkJxdBItbg"]=base64_decode("LA==");$GLOBALS["tugkmwKQmrdyfghQnRJj"]=base64_decode("");$GLOBALS["YBfRzBIoZpTEkcFcKNgP"]=base64_decode("UFNfTE9ZQUxUWV9WT1VDSEVSX0NBVEVHT1JZ");$GLOBALS["kRcLrhZXuXDpcYuzpmwx"]=base64_decode("dHJhbnNmb3JtYXRpb25fdGV4dA==");$GLOBALS["stPsEmZdhkBDWNBfXZtQ"]=base64_decode("Y2F0ZWdvcnlfdGV4dA==");$GLOBALS["TOeAMkZYbiIeTLssrRUI"]=base64_decode("Y291bnQ=");$GLOBALS["xdqLbjMkqNwAldSnYJvs"]=base64_decode("bGlzdA==");$GLOBALS["aQuZLtAcKEnDNSgCrOUx"]=base64_decode("bW9kdHBs");$GLOBALS["aRbFXpGNJoCqQsoKJrhE"]=base64_decode("bG95YWx0eQ==");$GLOBALS["eiMjHdOTkxJOAwMCNHkD"]=base64_decode("bW9k");$GLOBALS["NeEpoqFHXrKePHrDMboS"]=base64_decode("WS1tLWQ=");$GLOBALS["NQyMjpmtARzsdHodcqGo"]=base64_decode("ZGF0ZV90bw==");$GLOBALS["ilOmjgCCDCiqzZLwUyuL"]=base64_decode("QWxyZWFkeSB1c2Vk");$GLOBALS["BKLnukUfZYQjWrbqCHPc"]=base64_decode("UmVhZHkgdG8gdXNl");$GLOBALS["jvNUZuArDlDbVsDKKNjT"]=base64_decode("c3RhdHVz");$GLOBALS["KEIaVoEwhIoBCMBsuRaf"]=base64_decode("cXVhbnRpdHk=");$GLOBALS["ulKHpLyTKLxVrBIkXkKp"]=base64_decode("L21vZHVsZXMvbG95YWx0eS9Mb3lhbHR5U3RhdGVNb2R1bGUucGhw");$GLOBALS["ObLueeKbATghxYWafgAQ"]=base64_decode("L21vZHVsZXMvbG95YWx0eS9Mb3lhbHR5TW9kdWxlLnBocA==");$GLOBALS["vnikmTnwHXDcKJBQNHoK"]=base64_decode("TW9iaWNvbW1lcmNlaGVscGVy");$GLOBALS["PdepTkCacGhHbSYynMub"]=base64_decode("SFRUUC8xLjEgNDA0IE5vdCBGb3VuZA==");$GLOBALS["QIfjBqYCYzCTbgddRxFH"]=base64_decode("SU5fTU9CSUNPTU1FUkNF");$GLOBALS["XZZXGVeMjgdKNSTiQTs"]=base64_decode("Y2FydF9ydWxlX3Byb2R1Y3RfcnVsZV92YWx1ZSAoaWRfcHJvZHVjdF9ydWxlLCBpZF9pdGVtKSBWQUxVRVMg");$GLOBALS["AKjXkTxZjUraJOWjUAtW"]=base64_decode("Jyk=");$GLOBALS["vmrMnBtAHGmgCxLkXfbV"]=base64_decode("JywgJw==");$GLOBALS["TyhjBTOIlPEIcQfNE"]=base64_decode("KCc=");$GLOBALS["uYYoruFezzRiPDdNPMpQ"]=base64_decode("JywgJ2NhdGVnb3JpZXMnKQ==");$GLOBALS["fRaFBXVAPWSZvKskVTZb"]=base64_decode("Y2FydF9ydWxlX3Byb2R1Y3RfcnVsZSAoaWRfcHJvZHVjdF9ydWxlX2dyb3VwLCB0eXBlKSBWQUxVRVMgKCc=");$GLOBALS["lRRnJpfrfxUVnnSFjFjc"]=base64_decode("JywgMSk=");$GLOBALS["vQDymABZoygwjcCIBaxg"]=base64_decode("Y2FydF9ydWxlX3Byb2R1Y3RfcnVsZV9ncm91cCAoaWRfY2FydF9ydWxlLCBxdWFudGl0eSkgVkFMVUVTICgn");$GLOBALS["mvNZqfyaJaIgfHTGGHXL"]=base64_decode("SU5TRVJUIElOVE8g");$GLOBALS["mphyAqbsfiBMTKVjJQ"]=base64_decode("QWxs");$GLOBALS["YupmFrjNcEptorPoHgZG"]=base64_decode("Vm91Y2hlcnMgZ2VuZXJhdGVkIGhlcmUgYXJlIHVzYWJsZSBpbiB0aGUgZm9sbG93aW5nIGNhdGVnb3JpZXMgOiA=");$GLOBALS["ZUKrugOOGNsUDYpyIlzG"]=base64_decode("IA==");$GLOBALS["uzoJXPpNMkAPmuxPHPGD"]=base64_decode("VHJhbnNmb3JtIG15IHBvaW50cyBpbnRvIGEgdm91Y2hlciBvZg==");$GLOBALS["SnsSSwMKZSYeMFnEirnh"]=base64_decode("");
?><?php


if (!defined($GLOBALS["QIfjBqYCYzCTbgddRxFH"]))
{
    header($GLOBALS["PdepTkCacGhHbSYynMub"]);
    die();
}


class VoucherService extends BaseService
{
    private $errors = array();
    private $context;

    public function __construct()
    {
        parent::__construct();
        ServiceFactory::factory($GLOBALS["vnikmTnwHXDcKJBQNHoK"])->autoLoginMobileUser();

        include_once(_PS_ROOT_DIR_.$GLOBALS["ObLueeKbATghxYWafgAQ"]);
        include_once(_PS_ROOT_DIR_.$GLOBALS["ulKHpLyTKLxVrBIkXkKp"]);

        $this->context = Context::getContext();
    }

    public function getVoucherPoints($p = 0, $n = 0)
    {
        $cart_rules = CartRule::getCustomerCartRules($this->context->language->id, $this->context->customer->id, true, false);

        $rules = array();
        if($cart_rules){
            foreach($cart_rules as $_rule){
                if($_rule[$GLOBALS["KEIaVoEwhIoBCMBsuRaf"]] > 0){
                    $_rule[$GLOBALS["jvNUZuArDlDbVsDKKNjT"]] = $GLOBALS["BKLnukUfZYQjWrbqCHPc"];
                }
                else{
                    $_rule[$GLOBALS["jvNUZuArDlDbVsDKKNjT"]] = $GLOBALS["ilOmjgCCDCiqzZLwUyuL"];
                }
                $_rule[$GLOBALS["NQyMjpmtARzsdHodcqGo"]] = date($GLOBALS["NeEpoqFHXrKePHrDMboS"], strtotime($_rule[$GLOBALS["NQyMjpmtARzsdHodcqGo"]]));
                $rules[] = $_rule;
            }
        }

        
        

        $customer_points = (int)LoyaltyModule::getPointsByCustomer((int)$this->context->customer->id);
        $transformation_allowed = $customer_points > 0;
        $transformation_text = $GLOBALS["SnsSSwMKZSYeMFnEirnh"];
        if($transformation_allowed){
            $transformation_text = $this->l($GLOBALS["uzoJXPpNMkAPmuxPHPGD"], array(
                'mod' => 'loyalty',
                'modtpl' => 'loyalty',
                ));
            $transformation_text .= $GLOBALS["ZUKrugOOGNsUDYpyIlzG"];
            $transformation_text .= LoyaltyModule::getVoucherValue($customer_points, (int)$this->context->currency->id);
        }
        
        $result = array(
            'list' => $rules,
            'count' => count($rules),
            $GLOBALS["stPsEmZdhkBDWNBfXZtQ"] => $this->getCategoryText(),
            $GLOBALS["kRcLrhZXuXDpcYuzpmwx"] => $transformation_text,
            
            );
        return $result;
        
    }

    public function getCategoryText()
    {
        $all_categories = Category::getSimpleCategories((int)$this->context->cookie->id_lang);
        $voucher_categories = Configuration::get($GLOBALS["YBfRzBIoZpTEkcFcKNgP"]);
        if ($voucher_categories != $GLOBALS["tugkmwKQmrdyfghQnRJj"] && $voucher_categories != 0)
            $voucher_categories = explode($GLOBALS["lRBzvzBSEQkJxdBItbg"], Configuration::get($GLOBALS["YBfRzBIoZpTEkcFcKNgP"]));
        else
            die(Tools::displayError());

        if (count($voucher_categories) == count($all_categories))
            $categories_names = null;
        else
        {
            $categories_names = array();
            foreach ($all_categories as $k => $all_category)
                if (in_array($all_category[$GLOBALS["QVWFuLyKVyGmMRnfrqPG"]], $voucher_categories))
                    $categories_names[$all_category[$GLOBALS["QVWFuLyKVyGmMRnfrqPG"]]] = trim($all_category[$GLOBALS["BoWuBfavKqJxeLgCuLA"]]);
            if (!empty($categories_names))
                $categories_names = Tools::truncate(implode($GLOBALS["UErXESVgiXETbMaUsAvm"], $categories_names), 100).$GLOBALS["hQMtQEXNnpjUEYrLmOsm"];
            else
                $categories_names = null;
        }

        $text = $this->l($GLOBALS["YupmFrjNcEptorPoHgZG"], array(
            'mod' => 'loyalty',
            'modtpl' => 'loyalty',
            ));
        if($categories_names){
            $text .= $categories_names;
        }
        else{
            $text .= $this->l($GLOBALS["mphyAqbsfiBMTKVjJQ"], array(
                'mod' => 'loyalty',
                'modtpl' => 'loyalty',
                ));
        }
        return $text;
    }

    public function processVoucherPoints($data)
    {
        $customer_points = (int)LoyaltyModule::getPointsByCustomer((int)$this->context->customer->id);
        if ($customer_points > 0)
        {
            
            $voucher_code = null;
            do
                $voucher_code = $GLOBALS["dinfSBXNSzPHmrudLI"].rand(1000, 100000);
            while (CartRule::cartRuleExists($voucher_code));

            
            $cart_rule = new CartRule();
            $cart_rule->code = $voucher_code;
            $cart_rule->id_customer = (int)$this->context->customer->id;
            $cart_rule->reduction_currency = (int)$this->context->currency->id;
            $cart_rule->reduction_amount = LoyaltyModule::getVoucherValue((int)$customer_points);
            $cart_rule->quantity = 1;
            $cart_rule->highlight = 1;
            $cart_rule->quantity_per_user = 1;
            $cart_rule->reduction_tax = (bool)Configuration::get($GLOBALS["qrenbSKokZGqIzIJUSaC"]);

            
            $date_from = Db::getInstance()->getValue($GLOBALS["EeoKhzjXRMpgceXmBUCz"]._DB_PREFIX_.$GLOBALS["zXDVVUikoCFlqUnxPsMX"].(int)$this->context->cookie->id_customer.$GLOBALS["niQwzeioWeGsKCNcKt"]);

            if (Configuration::get($GLOBALS["OhNAyUgOhHqvgQJDhxqx"]))
                $date_from += 60 * 60 * 24 * (int)Configuration::get($GLOBALS["CAGOFrnvdgvRWJOFcHBQ"]);

            $cart_rule->date_from = date($GLOBALS["WhhfbVVjffUiUYQXixVQ"], $date_from);
            $cart_rule->date_to = date($GLOBALS["WhhfbVVjffUiUYQXixVQ"], strtotime($cart_rule->date_from.$GLOBALS["dlHOvghzOzgIapbTEaBm"]));

            $cart_rule->minimum_amount = (float)Configuration::get($GLOBALS["jmyCGszUIpGoCyjUqpfn"]);
            $cart_rule->minimum_amount_currency = (int)$this->context->currency->id;
            $cart_rule->active = 1;

            $categories = Configuration::get($GLOBALS["YBfRzBIoZpTEkcFcKNgP"]);
            if ($categories != $GLOBALS["tugkmwKQmrdyfghQnRJj"] && $categories != 0)
                $categories = explode($GLOBALS["lRBzvzBSEQkJxdBItbg"], Configuration::get($GLOBALS["YBfRzBIoZpTEkcFcKNgP"]));
            else
                die (Tools::displayError());

            $languages = Language::getLanguages(true);
            $default_text = Configuration::get($GLOBALS["HFpPpqIwKxtqqkQFORvs"], (int)Configuration::get($GLOBALS["feSiCyHZJEsqYvpXxAka"]));

            foreach ($languages as $language)
            {
                $text = Configuration::get($GLOBALS["HFpPpqIwKxtqqkQFORvs"], (int)$language[$GLOBALS["waWafEeALmeXuRDBxZD"]]);
                $cart_rule->name[(int)$language[$GLOBALS["waWafEeALmeXuRDBxZD"]]] = $text ? strval($text) : strval($default_text);
            }


            $contains_categories = is_array($categories) && count($categories);
            if ($contains_categories)
                $cart_rule->product_restriction = 1;
            $cart_rule->add();

            
            if ($contains_categories)
            {

                
                $id_cart_rule = (int)$cart_rule->id;
                $sql = $GLOBALS["mvNZqfyaJaIgfHTGGHXL"]._DB_PREFIX_.$GLOBALS["vQDymABZoygwjcCIBaxg"].$id_cart_rule.$GLOBALS["lRRnJpfrfxUVnnSFjFjc"];
                Db::getInstance()->execute($sql);
                $id_group = (int)Db::getInstance()->Insert_ID();

                
                $sql = $GLOBALS["mvNZqfyaJaIgfHTGGHXL"]._DB_PREFIX_.$GLOBALS["fRaFBXVAPWSZvKskVTZb"].$id_group.$GLOBALS["uYYoruFezzRiPDdNPMpQ"];
                Db::getInstance()->execute($sql);
                $id_product_rule = (int)Db::getInstance()->Insert_ID();

                
                $values = array();
                foreach ($categories as $category) {
                    $category = (int)$category;
                    $values[] = $GLOBALS["TyhjBTOIlPEIcQfNE"].$id_product_rule.$GLOBALS["vmrMnBtAHGmgCxLkXfbV"].$category.$GLOBALS["AKjXkTxZjUraJOWjUAtW"];
                }
                $values = implode($GLOBALS["lRBzvzBSEQkJxdBItbg"], $values);
                $sql = $GLOBALS["mvNZqfyaJaIgfHTGGHXL"]._DB_PREFIX_.$GLOBALS["XZZXGVeMjgdKNSTiQTs"].$values.$GLOBALS["SnsSSwMKZSYeMFnEirnh"];
                Db::getInstance()->execute($sql);
            }



            
            if (!LoyaltyModule::registerDiscount($cart_rule))
                $cart_rule->delete();
        }
    }
}
 ?>